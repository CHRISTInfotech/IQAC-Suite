{% extends "base.html" %}
{% load static %}

{% block title %}Submit Proposal | IQAC Suite{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tom-select@2.4.0/dist/css/tom-select.bootstrap5.min.css">
<link rel="stylesheet" href="{% static 'emt/css/styles.css' %}">
<link rel="stylesheet" href="{% static 'emt/css/proposal_drafts.css' %}">
<style>
  .proposal-shell { max-width: 1400px; margin: 0 auto; }
  .proposal-header { display: flex; justify-content: space-between; align-items: center; gap: 1.5rem; margin-bottom: 1.5rem; }
  .proposal-header h1 { margin: 0; font-size: 1.6rem; font-weight: 700; color: #1f3f75; }
  .proposal-header p { margin: 0; color: #475569; }
  .status-chips { display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap; }
  .status-chip { display: inline-flex; align-items: center; gap: 0.4rem; padding: 0.35rem 0.85rem; border-radius: 999px; font-size: 0.82rem; font-weight: 600; background: #eff6ff; color: #1d4ed8; border: 1px solid rgba(29,78,216,0.2); }
  #autosave-indicator { background: #ecfdf5; color: #047857; border: 1px solid rgba(4,120,87,0.3); }
  .proposal-content { flex: 1; min-width: 0; }
  .form-panel { background: #fff; border-radius: 18px; box-shadow: 0 24px 60px rgba(15,23,42,0.08); padding: 2rem; }
  .form-panel-header { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem; }
  .form-panel-header h2 { margin: 0; font-size: 1.25rem; color: #0f172a; font-weight: 700; }
  .form-panel-header span { color: #64748b; }
  .form-panel-content { min-height: 420px; }
  .form-errors { background: #fef2f2; border: 1px solid #dc2626; color: #b91c1c; border-radius: 12px; padding: 1rem 1.25rem; margin-bottom: 1.5rem; }
  .form-errors ul { margin: 0; padding-left: 1.2rem; }
  .nav-status { margin-left: auto; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.08em; }
  .proposal-nav .nav-link { align-items: center; gap: 0.85rem; }
  .proposal-nav .nav-link .nav-meta { display: flex; flex-direction: column; gap: 0.15rem; }
  .proposal-nav .nav-link .nav-meta span { display: block; }
  .proposal-nav .nav-link .nav-item-subtitle { font-size: 0.74rem; color: #94a3b8; }
  .progress-wrapper { display: flex; align-items: center; gap: 1rem; margin-bottom: 1.25rem; }
  .progress-bar-track { flex: 1; height: 6px; border-radius: 999px; background: #e2e8f0; overflow: hidden; }
  .progress-bar-fill { width: 0; height: 100%; background: linear-gradient(135deg, #2563eb, #1d4ed8); transition: width 0.3s ease; }
  .progress-label { font-size: 0.75rem; font-weight: 600; color: #475569; }
  .form-footer { display: flex; justify-content: space-between; align-items: center; gap: 1rem; margin-top: 2rem; }
  .fallback-actions { display: flex; gap: 0.75rem; flex-wrap: wrap; }
  .fallback-actions .btn { border-radius: 999px; padding: 0.6rem 1.6rem; font-weight: 600; }
  .loading-overlay { position: fixed; inset: 0; background: rgba(15,23,42,0.3); display: flex; align-items: center; justify-content: center; z-index: 5000; opacity: 0; visibility: hidden; transition: opacity 0.2s ease; }
  .loading-overlay.show { opacity: 1; visibility: visible; }
  .loading-overlay .spinner-border { width: 3rem; height: 3rem; }
  .proposal-layout { display: flex; gap: 2rem; align-items: flex-start; }
  @media (max-width: 1024px) {
    .proposal-layout { flex-direction: column; }
    .proposal-nav { width: 100%; position: static; max-height: none; }
    .proposal-nav .nav-link { padding: 0.9rem 1.25rem; }
    .form-panel { padding: 1.5rem; }
  }
</style>
{% endblock %}

{% block head_extra %}
<script>
  window.PROPOSAL_ID = {{ proposal.id|default:'null' }};
  window.AUTOSAVE_ENDPOINT = "{% url 'emt:autosave_proposal' %}";
  window.RESET_DRAFT_URL = "{% url 'emt:reset_proposal_draft' %}";
  window.RESET_DRAFT_REDIRECT_URL = "{% url 'emt:proposal_drafts' %}";
  window.API_ORGANIZATIONS = "{% url 'emt:api_organizations' %}";
  window.API_FACULTY = "{% url 'emt:api_faculty' %}";
  window.API_STUDENTS = "{% url 'emt:api_students' %}";
  window.API_CLASSES_BASE = "{% url 'emt:api_classes' 0 %}".replace(/0\/$/, '');
  window.API_FETCH_LINKEDIN = "{% url 'emt:fetch_linkedin_profile' %}";
  window.API_OUTCOMES_BASE = "{% url 'emt:api_outcomes' 0 %}".replace(/0\/$/, '');
  window.PROPOSAL_STATUS_URL = "{% url 'emt:proposal_status_detail' proposal.id %}";
  window.REVIEW_PROPOSAL_URL = "{% url 'emt:review_proposal' proposal.id %}";
  window.PROPOSAL_LIVE_STATE_URL = "{% url 'emt:proposal_live_state' proposal.id %}";
  window.SDG_GOALS = {{ sdg_goals_list|default:'[]'|safe }};
  window.EXISTING_ACTIVITIES = {{ activities_json|default:'[]'|safe }};
  window.EXISTING_SPEAKERS = {{ speakers_json|default:'[]'|safe }};
  window.EXISTING_EXPENSES = {{ expenses_json|default:'[]'|safe }};
  window.EXISTING_INCOME = {{ income_json|default:'[]'|safe }};
  window.AUTOSAVE_CSRF = "{{ csrf_token }}";
</script>
{% endblock %}

{% block content %}
<div class="container-fluid py-4 proposal-shell">
  <div class="proposal-layout">
    <nav class="proposal-nav" aria-label="Event proposal steps">
      <div class="nav-header">
        <h2 class="nav-title">Submit Proposal</h2>
        <p class="nav-subtitle">Complete each section to continue</p>
      </div>
      <ul class="nav-items">
        <li class="nav-item">
          <a class="nav-link active" data-order="1" data-section="basic-info" href="javascript:void(0);">
            <span class="nav-number">1</span>
            <span class="nav-meta">
              <span class="nav-item-title">Basic information</span>
              <span class="nav-item-subtitle">Organisation & event overview</span>
            </span>
            <span class="nav-status">Start</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link disabled" data-order="2" data-section="why-this-event" href="javascript:void(0);">
            <span class="nav-number">2</span>
            <span class="nav-meta">
              <span class="nav-item-title">Why this event?</span>
              <span class="nav-item-subtitle">Need, objectives & outcomes</span>
            </span>
            <span class="nav-status">Locked</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link disabled" data-order="3" data-section="schedule" href="javascript:void(0);">
            <span class="nav-number">3</span>
            <span class="nav-meta">
              <span class="nav-item-title">Schedule</span>
              <span class="nav-item-subtitle">Activities & tentative flow</span>
            </span>
            <span class="nav-status">Locked</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link disabled" data-order="4" data-section="speakers" href="javascript:void(0);">
            <span class="nav-number">4</span>
            <span class="nav-meta">
              <span class="nav-item-title">Speakers</span>
              <span class="nav-item-subtitle">Profiles & bios</span>
            </span>
            <span class="nav-status">Locked</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link disabled" data-order="5" data-section="expenses" href="javascript:void(0);">
            <span class="nav-number">5</span>
            <span class="nav-meta">
              <span class="nav-item-title">Expenses</span>
              <span class="nav-item-subtitle">Budget estimates</span>
            </span>
            <span class="nav-status">Locked</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link disabled" data-order="6" data-section="income" href="javascript:void(0);">
            <span class="nav-number">6</span>
            <span class="nav-meta">
              <span class="nav-item-title">Income</span>
              <span class="nav-item-subtitle">Projected sources</span>
            </span>
            <span class="nav-status">Locked</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link disabled" data-order="7" data-section="cdl-support" data-url="{% url 'emt:submit_cdl_support' proposal.id %}" href="javascript:void(0);">
            <span class="nav-number">7</span>
            <span class="nav-meta">
              <span class="nav-item-title">CDL support</span>
              <span class="nav-item-subtitle">Design & collateral</span>
            </span>
            <span class="nav-status">Locked</span>
          </a>
        </li>
      </ul>
    </nav>

    <div class="proposal-content">
      <header class="proposal-header">
        <div>
          <h1 id="main-title">Basic information</h1>
          <p id="main-subtitle">Tell us about the event you are planning.</p>
        </div>
        <div class="status-chips">
          <span class="status-chip">Draft autosaves every few seconds</span>
          <span class="status-chip" id="autosave-indicator" aria-live="polite">All changes saved</span>
        </div>
      </header>

      <div class="progress-wrapper" aria-hidden="false">
        <div class="progress-bar-track" role="progressbar" aria-valuemin="0" aria-valuemax="100">
          <div class="progress-bar-fill" id="overall-progress-fill"></div>
        </div>
        <span class="progress-label" id="overall-progress-text">0% complete</span>
      </div>

      {% if form.errors %}
      <div class="form-errors" role="alert">
        <p class="mb-2 fw-semibold">We found some issues when saving your proposal:</p>
        <ul>
          {% for field, errors in form.errors.items %}
            {% for error in errors %}
              {% if field == '__all__' %}
                <li>{{ error }}</li>
              {% else %}
                <li><strong>{{ field|capfirst }}</strong>: {{ error }}</li>
              {% endif %}
            {% endfor %}
          {% endfor %}
        </ul>
      </div>
      {% endif %}

      <div class="form-panel" id="form-panel">
        <div class="form-panel-header">
          <div>
            <h2 id="panel-title">Complete the section</h2>
            <span id="panel-subtitle">Fill the fields below and click <strong>Save & Continue</strong>.</span>
          </div>
          <button type="button" class="btn btn-sm btn-outline-secondary" id="reset-draft-btn">Reset draft</button>
        </div>

        <form id="proposal-form" method="post" enctype="multipart/form-data" action="{% url 'emt:submit_proposal_with_pk' proposal.id %}">
          {% csrf_token %}
          {{ form.media }}
          <noscript>
            <div class="alert alert-warning mb-3">This page works best with JavaScript enabled. You can still fill the hidden Django form fields below.</div>
          </noscript>

          <div id="form-panel-content" class="form-panel-content">
            <div class="text-center py-5">
              <div class="spinner-border text-primary" role="status" aria-hidden="true"></div>
              <p class="mt-3 text-muted">Preparing interactive form…</p>
            </div>
          </div>

          <div class="form-footer">
            <div class="fallback-actions">
              <button type="submit" name="save_draft" class="btn btn-outline-secondary">Save draft</button>
              <button type="submit" name="review_submit" class="btn btn-primary">Submit for review</button>
              <button type="submit" name="final_submit" class="btn btn-success">Submit & notify IQAC</button>
            </div>
            <a href="{% url 'emt:proposal_drafts' %}" class="text-decoration-none">Back to drafts</a>
          </div>

          <div id="django-forms" style="display:none;">
            <div id="django-basic-info">
              {% for field in form %}
                {{ field }}
              {% endfor %}
              <input type="hidden" name="committees_collaborations_ids" id="committees-collaborations-ids" value="">
            </div>
            <textarea id="id_need_analysis" name="need_analysis">{{ need_analysis.content|default_if_none:'' }}</textarea>
            <textarea id="id_objectives" name="objectives">{{ objectives.content|default_if_none:'' }}</textarea>
            <textarea id="id_learning_outcomes" name="outcomes">{{ outcomes.content|default_if_none:'' }}</textarea>
            <textarea id="id_tentative_flow" name="flow">{{ flow.content|default_if_none:'' }}</textarea>
            <textarea id="schedule-modern" name="schedule" style="display:none;"></textarea>
            <input type="hidden" name="activities_json" value="{{ activities_json|default:'[]' }}">
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<div id="audienceModal" class="modal audience-modal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Select target audience</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="audience-selector" id="audienceList">
          <div class="placeholder text-center text-muted py-5">Use the search controls to pick students, faculty, or custom groups.</div>
        </div>
        <div class="audience-custom mt-3">
          <label for="audienceCustomInput" class="form-label">Custom audience description</label>
          <input type="text" id="audienceCustomInput" class="form-control" placeholder="e.g., First year BSc Data Science">
        </div>
      </div>
      <div class="modal-footer justify-content-between">
        <span class="text-muted small">Selections are autosaved to the proposal.</span>
        <div>
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="audienceApplyBtn">Apply selection</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="sdgModal" class="modal sdg-modal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Aligned SDG goals</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="sdgList" class="row row-cols-1 row-cols-md-2 g-3">
          <!-- Goals populated by JS -->
        </div>
      </div>
      <div class="modal-footer justify-content-between">
        <small class="text-muted">Pick the Sustainable Development Goals supported by this event.</small>
        <div>
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="sdgSaveBtn">Save goals</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="outcomeModal" class="modal outcome-modal" data-url="" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Graduate attributes & PO/PSO</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="placeholder text-center text-muted py-5">Choose an organisation to view available graduate attributes.</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<div id="loadingOverlay" class="loading-overlay" role="status" aria-live="polite" aria-label="Saving proposal">
  <div class="spinner-border text-light"></div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'emt/js/jquery-3.7.1.min.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.4.0/dist/js/tom-select.complete.min.js"></script>
<script src="{% static 'emt/js/autosave_draft.js' %}"></script>
<script src="{% static 'emt/js/proposal_live_sync.js' %}"></script>
<script src="{% static 'emt/js/proposal_dashboard.js' %}"></script>
{% endblock %}
