{% extends 'base.html' %}
{% load static %}

{% block title %}My Profile - Faculty Dashboard{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'core/css/profile.css' %}">
<link rel="stylesheet" href="{% static 'core/css/dashboard.css' %}">

<div class="dashboard-profile-container">
  <!-- Navigation Bar -->
  <div class="dashboard-nav-bar">
    <div class="nav-left">
      <a href="{% url 'dashboard' %}" class="back-btn">
        <i class="fas fa-arrow-left"></i>
        <span>Back to Dashboard</span>
      </a>
    </div>
    <div class="nav-center">
      <h1 class="nav-title">Faculty Profile</h1>
    </div>
    <div class="nav-right">
      <span class="user-badge faculty-badge">
        <i class="fas fa-chalkboard-teacher"></i>
        Faculty
      </span>
    </div>
  </div>

  <!-- Profile Header -->
  <div class="profile-header-section faculty-header">
    <div class="profile-header-container">
      <div class="profile-left-section">
        <div class="profile-basic-info">
          <h1 class="profile-title">{{ user.get_full_name|default:user.username }}</h1>
          <p class="profile-subtitle">{{ user.email|default:"Email not set" }}</p>
          <p class="profile-reg-number">
            <i class="fas fa-id-badge"></i>
            <span>Role:</span>
            <span>{{ user.profile.get_role_display|default:"Faculty" }}</span>
          </p>
        </div>
      </div>
      <div class="profile-stats-section">
        <div class="profile-stats-grid faculty-stats">
          <div class="stat-card">
            <div class="stat-icon">
              <i class="fas fa-calendar-check"></i>
            </div>
            <div class="stat-content">
              <div class="stat-number">{{ total_events|default:"0" }}</div>
              <div class="stat-label">EVENTS ORGANIZED</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">
              <i class="fas fa-chalkboard"></i>
            </div>
            <div class="stat-content">
              <div class="stat-number">{{ classes_count|default:"0" }}</div>
              <div class="stat-label">CLASSES</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Navigation Tabs -->
  <div class="profile-tabs-section">
    <div class="profile-tabs-container">
      <nav class="profile-tabs-nav">
        <button class="tab-btn active" onclick="showTab('professional-info')">
          <i class="fas fa-user-tie"></i>
          <span>Professional Info</span>
        </button>
        <button class="tab-btn" onclick="showTab('classes')">
          <i class="fas fa-chalkboard"></i>
          <span>My Classes</span>
        </button>
        <button class="tab-btn" onclick="showTab('students')">
          <i class="fas fa-user-graduate"></i>
          <span>My Students</span>
        </button>
        <button class="tab-btn" onclick="showTab('events')">
          <i class="fas fa-calendar-alt"></i>
          <span>Events Organized</span>
        </button>
        <button class="tab-btn" onclick="showTab('organizations')">
          <i class="fas fa-building"></i>
          <span>Organizations</span>
        </button>
      </nav>
    </div>
  </div>

  <!-- Content Section -->
  <div class="profile-content-section">
    <!-- Professional Info Tab -->
    <div id="professional-info" class="tab-content-panel active">
      <div class="content-row">
        <!-- Personal Information -->
        <div class="content-card large-card">
          <div class="card-header">
            <div class="header-left">
              <div class="header-icon">
                <i class="fas fa-user"></i>
              </div>
              <h2>Personal Information</h2>
            </div>
            <button class="edit-btn" onclick="editPersonalInfo()">
              <i class="fas fa-edit"></i>
            </button>
          </div>
          <div class="card-body">
            <div class="info-grid-expanded">
              <div class="info-section">
                <div class="info-item-large">
                  <div class="info-label">
                    <i class="fas fa-user"></i>
                    <span>Full Name</span>
                  </div>
                  <div class="info-value">{{ user.get_full_name|default:"Not Set" }}</div>
                </div>
                <div class="info-item-large">
                  <div class="info-label">
                    <i class="fas fa-at"></i>
                    <span>Email</span>
                  </div>
                  <div class="info-value">{{ user.email|default:"Not Set" }}</div>
                </div>
              </div>
              <div class="info-section">
                <div class="info-item-large">
                  <div class="info-label">
                    <i class="fas fa-user-tie"></i>
                    <span>Role</span>
                  </div>
                  <div class="info-value">{{ user.profile.get_role_display|default:"Faculty" }}</div>
                </div>
                <div class="info-item-large">
                  <div class="info-label">
                    <i class="fas fa-calendar-plus"></i>
                    <span>Date Joined</span>
                  </div>
                  <div class="info-value">{{ user.date_joined|date:"F d, Y"|default:"Unknown" }}</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Professional Status -->
        <div class="content-card medium-card">
          <div class="card-header">
            <div class="header-left">
              <div class="header-icon">
                <i class="fas fa-shield-alt"></i>
              </div>
              <h2>Professional Status</h2>
            </div>
          </div>
          <div class="card-body">
            <div class="status-list-compact">
              <div class="status-item-large">
                <div class="status-indicator active">
                  <i class="fas fa-check"></i>
                </div>
                <div class="status-content">
                  <div class="status-title">Faculty Member</div>
                  <div class="status-description">Active faculty in good standing</div>
                </div>
              </div>
              <div class="status-item-large">
                <div class="status-indicator verified">
                  <i class="fas fa-graduation-cap"></i>
                </div>
                <div class="status-content">
                  <div class="status-title">Teaching Access</div>
                  <div class="status-description">Authorized to manage classes and students</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Classes Tab -->
    <div id="classes" class="tab-content-panel">
      <div class="content-row">
        <div class="content-card full-width-card">
          <div class="card-header">
            <div class="header-left">
              <div class="header-icon">
                <i class="fas fa-chalkboard"></i>
              </div>
              <h2>My Classes</h2>
            </div>
            <div class="header-actions">
              <button class="btn btn-secondary" onclick="exportClasses()">
                <i class="fas fa-download"></i>
                Export List
              </button>
            </div>
          </div>
          <div class="card-body full-height">
            {% if my_classes %}
              <div class="classes-grid-expanded">
                {% for class in my_classes %}
                <div class="class-card-large">
                  <div class="class-header">
                    <div class="class-icon">
                      <i class="fas fa-chalkboard"></i>
                    </div>
                    <div class="class-info">
                      <h4>{{ class.name }}</h4>
                      <div class="class-code">{{ class.code }}</div>
                    </div>
                    <div class="class-actions">
                      <button class="action-btn" onclick="viewClass({{ class.id }})">
                        <i class="fas fa-eye"></i>
                      </button>
                      <button class="action-btn" onclick="manageClass({{ class.id }})">
                        <i class="fas fa-cog"></i>
                      </button>
                    </div>
                  </div>
                  <div class="class-details">
                    <div class="detail-item">
                      <i class="fas fa-users"></i>
                      <span>{{ class.students.count }} Students</span>
                    </div>
                    {% if class.academic_year %}
                    <div class="detail-item">
                      <i class="fas fa-calendar"></i>
                      <span>{{ class.academic_year }}</span>
                    </div>
                    {% endif %}
                    {% if class.organization %}
                    <div class="detail-item">
                      <i class="fas fa-building"></i>
                      <span>{{ class.organization.name }}</span>
                    </div>
                    {% endif %}
                  </div>
                </div>
                {% endfor %}
              </div>
            {% else %}
              <div class="empty-state-expanded">
                <div class="empty-icon">
                  <i class="fas fa-chalkboard"></i>
                </div>
                <div class="empty-content">
                  <h3>No Classes Assigned</h3>
                  <p>You don't have any classes assigned yet. Contact your department head or administrator to get class assignments.</p>
                  <a href="{% url 'dashboard' %}" class="btn btn-primary btn-lg">
                    <i class="fas fa-arrow-left"></i>
                    <span>Back to Dashboard</span>
                  </a>
                </div>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- Students Tab -->
    <div id="students" class="tab-content-panel">
      <div class="content-row">
        <div class="content-card full-width-card">
          <div class="card-header">
            <div class="header-left">
              <div class="header-icon">
                <i class="fas fa-user-graduate"></i>
              </div>
              <h2>My Students</h2>
            </div>
            <div class="header-actions">
              <button class="btn btn-secondary" onclick="exportStudents()">
                <i class="fas fa-download"></i>
                Export List
              </button>
            </div>
          </div>
          <div class="card-body full-height">
            {% if my_students %}
              <div class="students-grid-expanded">
                {% for student in my_students %}
                <div class="student-card-large">
                  <div class="student-header">
                    <div class="student-avatar">
                      <div class="avatar-placeholder small">
                        {{ student.user.get_full_name|default:student.user.username|slice:":1"|upper }}
                      </div>
                    </div>
                    <div class="student-info">
                      <h4>{{ student.user.get_full_name|default:student.user.username }}</h4>
                      <div class="student-email">{{ student.user.email }}</div>
                      {% if student.registration_number %}
                      <div class="student-reg">{{ student.registration_number }}</div>
                      {% endif %}
                    </div>
                    <div class="student-actions">
                      <button class="action-btn" onclick="viewStudent({{ student.id }})">
                        <i class="fas fa-eye"></i>
                      </button>
                      <button class="action-btn" onclick="contactStudent({{ student.id }})">
                        <i class="fas fa-envelope"></i>
                      </button>
                    </div>
                  </div>
                  <div class="student-details">
                    {% if student.department %}
                    <div class="detail-item">
                      <i class="fas fa-building-columns"></i>
                      <span>{{ student.department }}</span>
                    </div>
                    {% endif %}
                    {% if student.academic_year %}
                    <div class="detail-item">
                      <i class="fas fa-calendar"></i>
                      <span>{{ student.academic_year }}</span>
                    </div>
                    {% endif %}
                    <div class="detail-item">
                      <i class="fas fa-clock"></i>
                      <span>Last active: {{ student.user.last_login|timesince }} ago</span>
                    </div>
                  </div>
                </div>
                {% endfor %}
              </div>
            {% else %}
              <div class="empty-state-expanded">
                <div class="empty-icon">
                  <i class="fas fa-user-graduate"></i>
                </div>
                <div class="empty-content">
                  <h3>No Students Assigned</h3>
                  <p>You don't have any students assigned as mentees yet. Student assignments are typically managed by the department or administration.</p>
                  <a href="{% url 'dashboard' %}" class="btn btn-primary btn-lg">
                    <i class="fas fa-arrow-left"></i>
                    <span>Back to Dashboard</span>
                  </a>
                </div>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- Events Tab -->
    <div id="events" class="tab-content-panel">
      <div class="content-row">
        <div class="content-card full-width-card">
          <div class="card-header">
            <div class="header-left">
              <div class="header-icon">
                <i class="fas fa-calendar-check"></i>
              </div>
              <h2>Events Organized</h2>
            </div>
            <div class="header-actions">
              <a href="{% url 'emt:start_proposal' %}" class="btn btn-primary">
                <i class="fas fa-plus"></i>
                New Event
              </a>
            </div>
          </div>
          <div class="card-body full-height">
            {% if organized_events %}
              <div class="events-grid-expanded">
                {% for event in organized_events %}
                <div class="event-card-large faculty-event">
                  <div class="event-header">
                    <div class="event-icon">
                      <i class="fas fa-calendar-alt"></i>
                    </div>
                    <div class="event-info">
                      <h4>{{ event.event_title }}</h4>
                      <div class="event-meta">
                        {% if event.event_datetime %}
                        <span class="meta-item">
                          <i class="fas fa-clock"></i>
                          {{ event.event_datetime|date:"M d, Y" }}
                        </span>
                        {% endif %}
                        {% if event.venue %}
                        <span class="meta-item">
                          <i class="fas fa-map-marker-alt"></i>
                          {{ event.venue }}
                        </span>
                        {% endif %}
                      </div>
                    </div>
                    <div class="event-status">
                      <span class="status-badge status-{{ event.status }}">
                        {{ event.get_status_display }}
                      </span>
                    </div>
                  </div>
                  {% if event.description %}
                  <div class="event-description">
                    {{ event.description|truncatewords:20 }}
                  </div>
                  {% endif %}
                  <div class="event-actions">
                    <button class="btn btn-sm btn-secondary" onclick="viewEvent({{ event.id }})">
                      <i class="fas fa-eye"></i> View
                    </button>
                    {% if event.status == 'draft' %}
                    <button class="btn btn-sm btn-primary" onclick="editEvent({{ event.id }})">
                      <i class="fas fa-edit"></i> Edit
                    </button>
                    {% endif %}
                  </div>
                </div>
                {% endfor %}
              </div>
            {% else %}
              <div class="empty-state-expanded">
                <div class="empty-icon">
                  <i class="fas fa-calendar-alt"></i>
                </div>
                <div class="empty-content">
                  <h3>No Events Organized</h3>
                  <p>You haven't organized any events yet. Start by creating your first event proposal and managing the event lifecycle.</p>
                  <a href="{% url 'emt:start_proposal' %}" class="btn btn-primary btn-lg">
                    <i class="fas fa-plus"></i>
                    <span>Create Your First Event</span>
                  </a>
                </div>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- Organizations Tab -->
    <div id="organizations" class="tab-content-panel">
      <div class="content-row organizations-layout">
        <div class="content-card full-width-card organization-panel">
          <div class="card-header">
            <div class="header-left">
              <div class="header-icon">
                <i class="fas fa-building"></i>
              </div>
              <h2>My Organizations</h2>
            </div>
            <button class="btn btn-primary" type="button" onclick="joinOrganization()">
              <i class="fas fa-plus"></i>
              <span>Join Organization</span>
            </button>
          </div>
          <div class="card-body">
            {% if user_organizations %}
              <div class="organization-list" id="organization-list">
                {% for org in user_organizations %}
                <div class="organization-list-item" data-org-id="{{ org.id }}" data-can-leave="{{ org.can_leave|yesno:'true,false' }}">
                  <div class="org-summary">
                    <div class="org-name">{{ org.name }}</div>
                    <div class="org-meta">
                      {{ org.org_type_display }}{% if org.membership_role_label %} · {{ org.membership_role_label }}{% endif %}
                    </div>
                  </div>
                  <div class="org-extra">
                    {% if org.joined_date %}<span class="org-pill">Joined {{ org.joined_date|date:"M Y" }}</span>{% endif %}
                    {% if org.membership_academic_year %}<span class="org-pill">{{ org.membership_academic_year }}</span>{% endif %}
                    {% if not org.can_leave %}<span class="org-pill org-pill-muted">Admin managed</span>{% endif %}
                  </div>
                  <div class="org-actions">
                    <button class="btn btn-icon" type="button" onclick="viewOrganization({{ org.id }})" title="View organization">
                      <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-icon" type="button" onclick="manageOrganization({{ org.id }})" title="Manage organization">
                      <i class="fas fa-cog"></i>
                    </button>
                    {% if org.can_leave %}
                    <button class="btn btn-icon" type="button" data-action="leave" title="Request to leave" onclick="leaveOrganization({{ org.id }})">
                      <i class="fas fa-sign-out-alt"></i>
                    </button>
                    {% else %}
                    <button class="btn btn-icon" type="button" disabled title="Managed by administrator">
                      <i class="fas fa-lock"></i>
                    </button>
                    {% endif %}
                  </div>
                </div>
                {% endfor %}
              </div>
            {% else %}
              <div class="empty-state-condensed">
                <i class="fas fa-building"></i>
                <p>You are not part of any organizations yet.</p>
                <button class="btn btn-primary btn-sm" type="button" onclick="joinOrganization()">
                  <i class="fas fa-plus"></i>
                  <span>Join Your First Organization</span>
                </button>
              </div>
            {% endif %}
          </div>
        </div>
      </div>

      <div class="content-row organizations-layout">
        <div class="content-card full-width-card">
          <div class="card-header">
            <div class="header-left">
              <div class="header-icon">
                <i class="fas fa-clipboard-list"></i>
              </div>
              <h2>Membership Requests</h2>
            </div>
          </div>
          <div class="card-body">
            <div id="join-requests-container">
              <div id="join-requests-list" class="join-requests-list"{% if not join_requests %} hidden{% endif %}>
                {% for request in join_requests %}
                <div class="join-request-row" data-request-id="{{ request.id }}" data-organization-id="{{ request.organization_id }}" data-request-type="{{ request.request_type }}">
                  <div class="join-request-main">
                    <span class="join-request-name">{{ request.organization.name }}</span>
                    <span class="join-request-meta">{{ request.get_request_type_display }} · {{ request.requested_on|date:"d MMM YYYY" }}</span>
                  </div>
                  <div class="join-request-status">
                    {% if request.status == 'Pending' and request.is_seen %}
                      <span class="status-pill status-pill-seen">Seen</span>
                    {% else %}
                      <span class="status-pill status-pill-{{ request.status|lower }}">{{ request.status }}</span>
                    {% endif %}
                  </div>
                  {% if request.response_message %}
                  <div class="join-request-response">{{ request.response_message }}</div>
                  {% endif %}
                </div>
                {% endfor %}
              </div>
              <div id="join-requests-empty" class="empty-state-condensed"{% if join_requests %} hidden{% endif %}>
                <i class="fas fa-inbox"></i>
                <p>No membership requests yet.</p>
                <button class="btn btn-secondary btn-sm" type="button" onclick="joinOrganization()">
                  <i class="fas fa-plus"></i>
                  <span>Submit Request</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{{ join_requests_payload|json_script:"join-requests-data" }}
<script src="{% static 'core/js/profile.js' %}"></script>
<script src="{% static 'core/js/profile_organizations.js' %}"></script>
<script src="{% static 'core/js/faculty_profile.js' %}"></script>
{% endblock %}
