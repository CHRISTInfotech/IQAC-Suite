{% extends "base.html" %}
{% load static %}
{% load role_filters %}  {# Add this line to load your custom filters #}

{% block head_extra %}
{{ block.super }}
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<!-- DataTables -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.css">
<script type="text/javascript" src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.js"></script>

<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />

<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css">

<!-- Custom CSS -->
<link rel="stylesheet" href="{% static 'core/css/admin_user_management.css' %}">

<style>
.filters-section {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
}

.filters-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.filters-header h5 {
    margin: 0;
    color: #495057;
    font-weight: 600;
}

.filter-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 15px;
}

.filter-group {
    display: flex;
    flex-direction: column;
}

.filter-group label {
    font-size: 0.9rem;
    font-weight: 500;
    color: #6c757d;
    margin-bottom: 5px;
}

.filter-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 15px;
}

.results-summary {
    background: #e9ecef;
    padding: 12px 16px;
    border-radius: 6px;
    margin-bottom: 15px;
    font-size: 0.95rem;
    color: #495057;
}

.active-filters {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 10px;
}

.filter-tag {
    background: #007bff;
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.8rem;
    display: flex;
    align-items: center;
    gap: 5px;
}

.filter-tag .remove-filter {
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    padding: 0;
    font-size: 0.9rem;
}

.toggle-filters {
    background: none;
    border: none;
    color: #007bff;
    font-size: 0.9rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 5px;
}

.filters-collapsed .filter-content {
    display: none;
}

/* Select2 Bootstrap 5 theme customizations */
.select2-container--bootstrap-5 .select2-selection {
    min-height: 38px;
}

.select2-container--bootstrap-5 .select2-selection--multiple {
    min-height: 38px;
}

.select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__choice {
    background-color: #007bff;
    border-color: #007bff;
    color: #fff;
    padding: 2px 8px;
    margin: 2px;
    border-radius: 12px;
}

.select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__choice__remove {
    color: #fff;
    margin-right: 5px;
}

.select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__choice__remove:hover {
    color: #fff;
    background-color: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
}

/* Loading spinner for Select2 */
.select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__rendered .select2-search--inline .select2-search__field:focus {
    outline: none;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .filter-row {
        grid-template-columns: 1fr;
        gap: 10px;
    }
    
    .active-filters {
        margin-top: 15px;
    }
    
    .filters-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
}

/* Custom Select2 dropdown styling */
.select2-container--bootstrap-5 .select2-dropdown {
    border-color: #ced4da;
}

.select2-container--bootstrap-5 .select2-search--dropdown .select2-search__field {
    border-color: #ced4da;
}

.select2-container--bootstrap-5 .select2-results__option--highlighted[aria-selected] {
    background-color: #007bff;
    color: #fff;
}

/* Impersonation role switcher styles */
.role-switch-dropdown {
    position: relative;
    display: inline-block;
}

.role-menu {
    min-width: 200px;
}

.current-role {
    font-weight: bold;
    background-color: #e9ecef;
}

.role-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 1rem;
}

.role-org {
    font-size: 0.85em;
    color: #6c757d;
    margin-left: 0.5rem;
}

.stop-impersonation {
    color: #dc3545;
    border-top: 1px solid #dee2e6;
}

/* Role Impersonation Section Styles */
.role-impersonation-section {
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
    padding: 1.5rem;
}

.role-impersonation-header {
    border-bottom: 1px solid #dee2e6;
    margin-bottom: 1rem;
    padding-bottom: 1rem;
}

.role-impersonation-header h4 {
    color: #2c3e50;
    margin: 0;
}

.organization-section {
    margin-bottom: 1.5rem;
}

.organization-name {
    color: #495057;
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.roles-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 1rem;
    margin-top: 0.5rem;
}

.role-card {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 1rem;
    transition: all 0.2s ease;
    cursor: pointer;
}

.role-card:hover {
    background: #e9ecef;
    border-color: #adb5bd;
}

.role-card.active {
    background: #e3f2fd;
    border-color: #90caf9;
}

.current-impersonation-status {
    background: #e8f5e9;
    border-radius: 6px;
    margin-bottom: 1rem;
    padding: 1rem;
}

.stop-impersonation-btn {
    background: #dc3545;
    color: white;
    border: none;
    padding: 0.375rem 0.75rem;
    border-radius: 4px;
    font-size: 0.875rem;
}

.stop-impersonation-btn:hover {
    background: #c82333;
}

/* Add these styles to help with table layout */
.roles-container,
.organizations-container {
    max-width: 200px;
    word-wrap: break-word;
}
    
.badge {
    white-space: normal;
    text-align: left;
}
    
.status-container {
    white-space: nowrap;
}
    
/* DataTables responsive styles */
.table-responsive {
    margin-bottom: 1rem;
}
    
@media screen and (max-width: 767px) {
    .roles-container,
    .organizations-container {
        max-width: none;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="user-mgmt-container">
    <h1 class="mgmt-title">User Management</h1>
    
    <!-- Enhanced Filters Section -->
    <div class="filters-section" id="filtersSection">
        <div class="filters-header">
            <h5><i class="fas fa-filter"></i> Advanced Filters</h5>
            <button type="button" class="toggle-filters" onclick="toggleFilters()">
                <span id="filterToggleText">Collapse</span>
                <i class="fas fa-chevron-up" id="filterToggleIcon"></i>
            </button>
        </div>
        
        <div class="filter-content">
            <div class="filter-row">
                <div class="filter-group">
                    <label for="q">Search Users</label>
                    <input type="text" class="form-control" id="q" name="q" value="{{ current_filters.q }}" 
                           placeholder="Name, email, username...">
                </div>
                
                <div class="filter-group">
                    <label for="status">Account Status</label>
                    <select class="form-select" id="status" name="status">
                        <option value="">All Status</option>
                        <option value="active" {% if current_filters.status == 'active' %}selected{% endif %}>Active</option>
                        <option value="inactive" {% if current_filters.status == 'inactive' %}selected{% endif %}>Inactive</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="org_type">Organization Type</label>
                    <select class="form-select" id="org_type" name="org_type[]" multiple>
                        {% for org_type in all_org_types %}
                            <option value="{{ org_type.id }}" 
                                {% if org_type.id|stringformat:"s" in current_filters.org_type %}selected{% endif %}>
                                {{ org_type.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="organization">Organization</label>
                    <select class="form-select" id="organization" name="organization[]" multiple>
                        {% for org in all_organizations %}
                            <option value="{{ org.id }}" 
                                {% if org.id|stringformat:"s" in current_filters.organization %}selected{% endif %}>
                                {{ org.name }} ({{ org.org_type.name }})
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <div class="filter-row">
                <div class="filter-group">
                    <label for="role">Organization Role</label>
                    <select class="form-select" id="role" name="role[]" multiple>
                        {% for role in all_roles %}
                            <option value="{{ role.id }}" 
                                {% if role.id|stringformat:"s" in current_filters.role %}selected{% endif %}>
                                {{ role.name }} ({{ role.organization.name }})
                            </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="filter-group">
                    <button type="button" class="btn btn-outline-secondary w-100" onclick="clearFilters()" style="margin-top: 32px;">
                        <i class="fas fa-times"></i> Clear All Filters
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Active Filters Display -->
        {% if current_filters.q or current_filters.role or current_filters.organization or current_filters.org_type or current_filters.status %}
        <div class="active-filters">
            <strong>Active Filters:</strong>
            {% if current_filters.q %}
                <span class="filter-tag">
                    Search: "{{ current_filters.q }}"
                    <button type="button" class="remove-filter" onclick="removeFilter('q')">&times;</button>
                </span>
            {% endif %}
            {% if current_filters.status %}
                <span class="filter-tag">
                    Status: {{ current_filters.status|title }}
                    <button type="button" class="remove-filter" onclick="removeFilter('status')">&times;</button>
                </span>
            {% endif %}
            {% if current_filters.org_type %}
                {% for ot_id in current_filters.org_type %}
                    {% for ot in all_org_types %}
                        {% if ot.id|stringformat:"s" == ot_id %}
                            <span class="filter-tag">
                                Org Type: {{ ot.name }}
                                <button type="button" class="remove-filter" onclick="removeFilterValue('org_type', '{{ ot.id }}')">&times;</button>
                            </span>
                        {% endif %}
                    {% endfor %}
                {% endfor %}
            {% endif %}
            {% if current_filters.organization %}
                {% for org_id in current_filters.organization %}
                    {% for org in all_organizations %}
                        {% if org.id|stringformat:"s" == org_id %}
                            <span class="filter-tag">
                                Organization: {{ org.name }}
                                <button type="button" class="remove-filter" onclick="removeFilterValue('organization', '{{ org.id }}')">&times;</button>
                            </span>
                        {% endif %}
                    {% endfor %}
                {% endfor %}
            {% endif %}
            {% if current_filters.role %}
                {% for role_id in current_filters.role %}
                    {% for role in all_roles %}
                        {% if role.id|stringformat:"s" == role_id %}
                            <span class="filter-tag">
                                Role: {{ role.name }}
                                <button type="button" class="remove-filter" onclick="removeFilterValue('role', '{{ role.id }}')">&times;</button>
                            </span>
                        {% endif %}
                    {% endfor %}
                {% endfor %}
            {% endif %}
        </div>
        {% endif %}
    </div>
    
    <!-- Results Summary -->
    {% if total_users is not None %}
    <div class="results-summary">
        <i class="fas fa-info-circle"></i>
        Showing {{ users|length }} of {{ total_users }} users
        {% if total_users != users|length %}
            (filtered from {{ total_users }} total)
        {% endif %}
    </div>
    {% endif %}

    <!-- Role Impersonation Section -->
    {% if request.user.is_staff or request.user.is_superuser %}
    <div class="role-impersonation-section mb-4">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-user-secret"></i> Role Impersonation</h5
                </div>
            </div>
            <div class="card-body">
                {% if current_role %}
                    <div class="alert alert-info d-flex justify-content-between align-items-center">
                        <span>
                            <strong>Current Role:</strong> 
                            {% for role_id, role_name in available_roles %}
                                {% if role_id == current_role %}
                                    {{ role_name }}
                                {% endif %}
                            {% endfor %}
                        </span>
                        <form action="{% url 'stop_role_impersonation' %}" method="POST" class="stop-impersonation-form">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-warning btn-sm">
                                <i class="fas fa-times"></i> Stop Impersonating
                            </button>
                        </form>
                    </div>
                {% endif %}

                <div class="dropdown">
                    <button class="btn btn-primary dropdown-toggle" type="button" id="roleDropdownBtn" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-exchange-alt"></i> Switch Role
                    </button>
                    <ul class="dropdown-menu" style="width: 200px;">
                        {% for role_id, role_name in available_roles %}
                            <li>
                                <form action="{% url 'start_role_impersonation' %}" method="POST" class="px-2 py-1">
                                    {% csrf_token %}
                                    <input type="hidden" name="role" value="{{ role_id }}">
                                    <button type="submit" class="dropdown-item {% if current_role == role_id %}active{% endif %}">
                                        {{ role_name }}
                                    </button>
                                </form>
                            </li>
                            {% if not forloop.last %}
                                <li><hr class="dropdown-divider"></li>
                            {% endif %}
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="table-responsive">
        <table id="myTable" class="admin-users-table table table-striped" style="width:100%">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Roles</th>
                    <th>Organization</th>
                    <th>Date Joined</th>
                    <th>Status</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>{{ user.get_full_name|default:user.username }}</td>
                    <td>{{ user.email|default:"No email" }}</td>
                    <td>
                        {% for ra in user.role_assignments.all %}
                            {{ ra.role.name }}{% if not forloop.last %}, {% endif %}
                        {% empty %}
                            No roles
                        {% endfor %}
                    </td>
                    <td>
                        {% for ra in user.role_assignments.all %}
                            {{ ra.organization.name }}{% if not forloop.last %}, {% endif %}
                        {% empty %}
                            No organization
                        {% endfor %}
                    </td>
                    <td>{{ user.date_joined|date:"M d, Y" }}</td>
                    <td>
                        {% if user.is_active %}Active{% else %}Inactive{% endif %}
                    </td>
                    <td>
                        <a href="{% url 'admin_user_edit' user.id %}" class="btn btn-sm btn-outline-primary">Edit</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>

<!-- DataTables Buttons -->
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.colVis.min.js"></script>

<!-- JSZip for Excel export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<!-- pdfmake for PDF export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

<script>
$(document).ready(function () {
    // Global variables for debouncing
    let filterTimeout;
    
    // Initialize DataTable
    const table = $('#myTable').DataTable({
        dom: '<"dt-toolbar d-flex justify-content-between align-items-center flex-wrap mb-3"lBf>rtip',
        responsive: true,
        pagingType: 'simple_numbers',
        lengthMenu: [
            [10, 25, 50, 100, -1],
            [10, 25, 50, 100, "All"]
        ],
        pageLength: 25,
        columnDefs: [
            { targets: [3, 4, 7], orderable: false }, // Roles, Organization, Action columns
        ],
        buttons: [
            {
                extend: 'colvis',
                text: '<i class="fa fa-eye"></i> Columns',
                className: 'btn btn-secondary btn-sm'
            },
            {
                extend: 'copyHtml5',
                text: '<i class="fa fa-copy"></i> Copy',
                className: 'btn btn-info btn-sm',
                exportOptions: { 
                    columns: ':visible:not(:last-child)' // Exclude action column
                }
            },
            {
                extend: 'excelHtml5',
                text: '<i class="fa fa-file-excel"></i> Excel',
                className: 'btn btn-success btn-sm',
                exportOptions: { 
                    columns: ':visible:not(:last-child)' // Exclude action column
                },
                title: 'User Management Report'
            },
            {
                extend: 'pdfHtml5',
                text: '<i class="fa fa-file-pdf"></i> PDF',
                className: 'btn btn-danger btn-sm',
                exportOptions: { 
                    columns: ':visible:not(:last-child)' // Exclude action column
                },
                title: 'User Management Report',
                orientation: 'landscape',
                pageSize: 'A4'
            },
            {
                extend: 'print',
                text: '<i class="fa fa-print"></i> Print',
                className: 'btn btn-primary btn-sm',
                exportOptions: { 
                    columns: ':visible:not(:last-child)' // Exclude action column
                },
                title: 'User Management Report'
            }
        ],
        order: [[5, 'desc']], // Order by Date Joined descending
        language: {
            search: "Search in table:",
            lengthMenu: "Show _MENU_ entries",
            info: "Showing _START_ to _END_ of _TOTAL_ users",
            paginate: {
                first: "First",
                last: "Last",
                next: "Next",
                previous: "Previous"
            }
        }
    });

    // Add some custom styling for buttons
    $('.dt-buttons .btn').css({
        'margin-right': '5px',
        'margin-bottom': '5px'
    });

    // Initialize filter persistence and UI
    window.filterManager = new FilterManager();
    window.filterManager.initializeFilters();
    window.filterManager.setupEventListeners();
    
    // Load saved filters on page load
    window.filterManager.loadSavedFilters();
});

/**
 * FilterManager class to handle all filter-related functionality
 */
class FilterManager {
    constructor() {
        this.filterTimeouts = {};
        this.filterCache = new Map();
        this.STORAGE_KEY = 'userMgmt_filters';
    }

    /**
     * Initialize all filter dropdowns with Select2
     */
    initializeFilters() {
        // Initialize multi-select dropdowns with Select2
        $('#org_type').select2({
            theme: 'bootstrap-5',
            placeholder: 'All Organization Types',
            allowClear: true,
            ajax: {
                url: '/core-admin/api/search/org-types/',
                dataType: 'json',
                delay: 300,
                data: function (params) {
                    return {
                        search: params.term || ''
                    };
                },
                processResults: function (data) {
                    return {
                        results: data.org_types.map(item => ({
                            id: item.id,
                            text: item.name
                        }))
                    };
                },
                cache: true
            }
        });

        $('#organization').select2({
            theme: 'bootstrap-5',
            placeholder: 'All Organizations',
            allowClear: true,
            ajax: {
                url: '/core-admin/api/filter/organizations/',
                dataType: 'json',
                delay: 300,
                data: function (params) {
                    const orgTypeIds = $('#org_type').val() || [];
                    return {
                        'org_type_ids[]': orgTypeIds,
                        search: params.term || ''
                    };
                },
                processResults: function (data) {
                    return {
                        results: data.organizations.map(item => ({
                            id: item.id,
                            text: `${item.name} (${item.org_type})`
                        }))
                    };
                },
                cache: false // Don't cache as it depends on org_type selection
            }
        });

        $('#role').select2({
            theme: 'bootstrap-5',
            placeholder: 'All Organization Roles',
            allowClear: true,
            ajax: {
                url: '/core-admin/api/filter/roles/',
                dataType: 'json',
                delay: 300,
                data: function (params) {
                    const organizationIds = $('#organization').val() || [];
                    return {
                        'organization_ids[]': organizationIds,
                        search: params.term || ''
                    };
                },
                processResults: function (data) {
                    return {
                        results: data.roles.map(item => ({
                            id: item.id,
                            text: `${item.name} (${item.organization})`
                        }))
                    };
                },
                cache: false // Don't cache as it depends on organization selection
            }
        });
    }

    /**
     * Setup event listeners for filter changes
     */
    setupEventListeners() {
        // Dynamic filtering - apply filters on change
        $('#status').on('change', () => {
            this.debounceFilter('status');
        });
        
        $('#org_type').on('change', () => {
            this.refreshDependentDropdowns();
            this.debounceFilter('org_type');
        });
        
        $('#organization').on('change', () => {
            this.refreshRolesDropdown();
            this.debounceFilter('organization');
        });
        
        $('#role').on('change', () => {
            this.debounceFilter('role');
        });
        
        // Debounced search for text input
        $('#q').on('input keyup', () => {
            this.debounceFilter('q', 800); // Longer delay for text input
        });
    }

    /**
     * Refresh dependent dropdowns when parent filters change
     */
    refreshDependentDropdowns() {
        // Clear and refresh organization dropdown when org_type changes
        $('#organization').val(null).trigger('change');
        $('#role').val(null).trigger('change');
    }

    /**
     * Refresh roles dropdown when organization changes
     */
    refreshRolesDropdown() {
        // Clear and refresh role dropdown when organization changes
        $('#role').val(null).trigger('change');
    }

    /**
     * Debounce filter application to avoid too many requests
     */
    debounceFilter(filterType, delay = 300) {
        clearTimeout(this.filterTimeouts[filterType]);
        this.filterTimeouts[filterType] = setTimeout(() => {
            this.applyFilters();
        }, delay);
    }

    /**
     * Apply all current filters
     */
    applyFilters() {
        const params = new URLSearchParams();
        
        // Get all filter values
        const q = $('#q').val().trim();
        const status = $('#status').val();
        const orgTypes = $('#org_type').val() || [];
        const organizations = $('#organization').val() || [];
        const roles = $('#role').val() || [];
        
        // Add non-empty parameters
        if (q) params.append('q', q);
        if (status) params.append('status', status);
        
        // Add multi-select parameters
        orgTypes.forEach(id => params.append('org_type[]', id));
        organizations.forEach(id => params.append('organization[]', id));
        roles.forEach(id => params.append('role[]', id));
        
        // Save filters to localStorage for persistence
        this.saveFilters({
            q, status, orgTypes, organizations, roles
        });
        
        // Update URL and reload page with new filters
        const newUrl = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
        window.location.href = newUrl;
    }

    /**
     * Save current filter state to localStorage
     */
    saveFilters(filters) {
        try {
            localStorage.setItem(this.STORAGE_KEY, JSON.stringify(filters));
        } catch (e) {
            console.warn('Failed to save filters to localStorage:', e);
        }
    }

    /**
     * Load saved filters from localStorage
     */
    loadSavedFilters() {
        // Only load saved filters if there are no URL parameters
        if (window.location.search) {
            return; // URL parameters take precedence
        }

        try {
            const saved = localStorage.getItem(this.STORAGE_KEY);
            if (saved) {
                const filters = JSON.parse(saved);
                
                // Apply saved filters to form elements
                if (filters.q) $('#q').val(filters.q);
                if (filters.status) $('#status').val(filters.status);
                
                // For Select2 dropdowns, we need to create options and trigger change
                if (filters.orgTypes && filters.orgTypes.length) {
                    // Add options for org types and set values
                    // Note: This assumes the options are already in the DOM or will be loaded by Select2
                    $('#org_type').val(filters.orgTypes).trigger('change');
                }
                
                if (filters.organizations && filters.organizations.length) {
                    $('#organization').val(filters.organizations).trigger('change');
                }
                
                if (filters.roles && filters.roles.length) {
                    $('#role').val(filters.roles).trigger('change');
                }
            }
        } catch (e) {
            console.warn('Failed to load saved filters:', e);
        }
    }

    /**
     * Clear all filters
     */
    clearAllFilters() {
        // Clear all filter inputs
        $('#q').val('');
        $('#status').val('');
        $('#org_type').val(null).trigger('change');
        $('#organization').val(null).trigger('change');
        $('#role').val(null).trigger('change');
        
        // Clear saved filters
        try {
            localStorage.removeItem(this.STORAGE_KEY);
        } catch (e) {
            console.warn('Failed to clear saved filters:', e);
        }
        
        // Redirect to clear URL parameters
        window.location.href = window.location.pathname;
    }
}

// Filter management functions (global for onclick handlers)
function toggleFilters() {
    const section = document.getElementById('filtersSection');
    const icon = document.getElementById('filterToggleIcon');
    const text = document.getElementById('filterToggleText');
    
    section.classList.toggle('filters-collapsed');
    
    if (section.classList.contains('filters-collapsed')) {
        icon.className = 'fas fa-chevron-down';
        text.textContent = 'Expand';
    } else {
        icon.className = 'fas fa-chevron-up';
        text.textContent = 'Collapse';
    }
}

function clearFilters() {
    if (window.filterManager) {
        window.filterManager.clearAllFilters();
    } else {
        // Fallback if filterManager is not available
        window.location.href = window.location.pathname;
    }
}

function removeFilter(filterName) {
    const url = new URL(window.location);
    url.searchParams.delete(filterName);
    
    // Also clear from localStorage
    try {
        const saved = localStorage.getItem('userMgmt_filters');
        if (saved) {
            const filters = JSON.parse(saved);
            delete filters[filterName];
            localStorage.setItem('userMgmt_filters', JSON.stringify(filters));
        }
    } catch (e) {
        console.warn('Failed to update saved filters:', e);
    }
    
    window.location.href = url.toString();
}

function removeFilterValue(filterName, value) {
    const url = new URL(window.location);
    const params = url.searchParams;
    
    // Get all values for this filter
    const currentValues = params.getAll(filterName + '[]');
    
    // Remove the specific value
    params.delete(filterName + '[]');
    currentValues.forEach(val => {
        if (val !== value) {
            params.append(filterName + '[]', val);
        }
    });
    
    // Also update localStorage
    try {
        const saved = localStorage.getItem('userMgmt_filters');
        if (saved) {
            const filters = JSON.parse(saved);
            const filterKey = filterName + 's'; // Convert to plural for consistency
            if (filters[filterKey] && Array.isArray(filters[filterKey])) {
                filters[filterKey] = filters[filterKey].filter(v => v !== value);
                localStorage.setItem('userMgmt_filters', JSON.stringify(filters));
            }
        }
    } catch (e) {
        console.warn('Failed to update saved filters:', e);
    }
    
    window.location.href = url.toString();
}
</script>
{% endblock %}

{% block extra_css %}
<style>
    .role-impersonation-section .dropdown-menu {
        max-height: 400px;
        overflow-y: auto;
    }

    .role-impersonation-section .dropdown-item {
        padding: 8px 16px;
        cursor: pointer;
    }

    .role-impersonation-section .dropdown-item.active {
        background-color: #e3f2fd;
        color: #0d6efd;
    }

    .role-impersonation-section .dropdown-item:hover {
        background-color: #f8f9fa;
    }
</style>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize dropdown
    var dropdownBtn = document.getElementById('roleDropdownBtn');
    if (dropdownBtn) {
        new bootstrap.Dropdown(dropdownBtn);
    }

    // Handle forms
    document.querySelectorAll('form').forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            const button = this.querySelector('button');
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            button.disabled = true;

            fetch(this.action, {
                method: 'POST',
                body: new FormData(this),
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.reload();
                } else {
                    alert(data.message || 'An error occurred');
                    button.innerHTML = originalText;
                    button.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while processing your request');
                button.innerHTML = originalText;
                button.disabled = false;
            });
        });
    });
});
</script>
{% endblock %}
