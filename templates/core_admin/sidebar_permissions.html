{% extends "base.html" %}
{% load static %}

{% block title %}Sidebar Permissions Management - CHRIST University{% endblock %}

{% block head_extra %}
  {# Reuse the master-data visual language #}
  <link rel="stylesheet" href="{% static 'core/css/admin_master_data.css' %}?v=3.0">
  <style>
    /* === Global Enhancements (added) === */
    /* Typing indicator underline for all inputs & selects */
    .permissions-page input[type=text],
    .permissions-page select {
      position: relative;
      background-clip: padding-box; /* keep background clean */
      box-shadow: inset 0 -2px 0 #c9d6e8; /* subtle idle underline */
      transition: box-shadow .25s ease, border-color .25s ease;
      caret-color: #1e60b1;
    }
    .permissions-page input[type=text]:focus,
    .permissions-page select:focus {
      box-shadow: inset 0 -3px 0 #1e60b1, 0 0 0 2px rgba(30,96,177,0.15);
      border-color: #1e60b1 !important;
    }
    .permissions-page input[type=text]::placeholder{color:#8ca2bc;}

    /* Overlay (loading / saving) */
    .permissions-page .screen-overlay{position:fixed;inset:0;background:rgba(255,255,255,0.85);display:flex;align-items:center;justify-content:center;z-index:2000;backdrop-filter:blur(2px);}
    .permissions-page .screen-overlay .overlay-card{background:#fff;padding:38px 46px;border-radius:20px;box-shadow:0 8px 40px -6px rgba(11,53,102,.25);display:flex;flex-direction:column;align-items:center;gap:18px;min-width:280px;}
    .permissions-page .screen-overlay .spinner{width:54px;height:54px;border-radius:50%;border:5px solid #e6edf5;border-top-color:#1e60b1;animation:spn 0.9s linear infinite;}
    @keyframes spn{to{transform:rotate(360deg)}}
    .permissions-page .screen-overlay .message{font-weight:700;font-size:16px;color:#1e60b1;letter-spacing:.5px;text-align:center;}
    .permissions-page .screen-overlay.saving .spinner{border-top-color:#0d7d3e;}
    .permissions-page .screen-overlay.saving .message{color:#0d7d3e;}

    /* Smooth selection transition */
    .permissions-page .item{transition:background .25s ease, box-shadow .25s ease, transform .2s ease;}
    .permissions-page .item.selected{outline:2px solid #1e60b180;}
  /* Partial folder indicator removed in new logic (entire group hidden if any child assigned) */

    /* ----- Page shell (reuses admin_master_data.css primitives) ----- */
    .permissions-page .topbar h1{margin:0;font-size:28px;font-weight:800;color:var(--ink)}
  .permissions-page .controls-container{position:sticky;top:0;z-index:40;background:transparent;border:0;border-radius:0;padding:0;box-shadow:none}

  /* Single-row toolbar */
  .permissions-page .toolbar-row{display:flex;align-items:center;gap:14px;flex-wrap:nowrap;overflow-x:auto;scrollbar-width:thin}
    .permissions-page .controls-container{
      position:sticky;
      top:0;
      z-index:50;
      background:transparent;
      border:0;
      box-shadow:none;
      margin-bottom:12px;
    }

    /* Professional toolbar-style filter design */
    .permissions-page .toolbar-filter{
      background:linear-gradient(135deg, #f8f9fb 0%, #ffffff 100%);
      border:1px solid #e1e8ed;
      border-radius:12px;
      padding:20px 24px;
      margin:12px 0;
      display:grid;
      grid-template-columns:1fr 1fr 1fr 1.6fr auto; /* even fill + larger search */
      gap:16px 24px;
      align-items:end;
      min-height:44px;
      position:relative;
      box-shadow:0 1px 3px rgba(0,0,0,0.1);
    }
    
    .permissions-page .toolbar-filter::after{
      content:'';
      position:absolute;
      bottom:0;
      left:24px;
      right:24px;
      height:1px;
      background:linear-gradient(90deg, transparent 0%, #e1e8ed 20%, #e1e8ed 80%, transparent 100%);
    }
    
    /* Field containers with improved spacing */
    .permissions-page .toolbar-field{
      position:relative;
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:0; /* allow grid to shrink without wrapping */
    }
    
    .permissions-page .toolbar-field label{
      font-size:12px;
      font-weight:600;
      color:#6b7280;
      text-transform:uppercase;
      letter-spacing:0.5px;
      margin-bottom:4px;
    }
    
    /* Enhanced input styling */
    .permissions-page .toolbar-input-container{
      position:relative;
      display:flex;
      align-items:center;
    }
    
    .permissions-page .toolbar-input-container .input-icon{
      position:absolute;
      left:14px;
      top:50%;
      transform:translateY(-50%);
      color:#9ca3af;
      font-size:14px;
      z-index:1;
      transition:color 0.2s ease;
    }
    
    .permissions-page .toolbar-field select,
    .permissions-page .toolbar-field input{
      width:100%;
      height:44px;
      border:1px solid #d1d5db;
      border-radius:8px;
      background:#ffffff;
      padding:0 16px 0 40px;
      font-size:14px;
      color:#374151;
      transition:all 0.2s ease;
      outline:none;
      box-shadow:0 1px 2px rgba(0,0,0,0.05);
      min-width:180px;
    }

    /* Compact dropdown (users/modules suggestions) */
    .permissions-page .suggest-dropdown{
      position:absolute;
      top:100%;
      left:0;
      right:0;
      margin-top:6px;
      background:#fff;
      border:1px solid #e1e8ed;
      border-radius:10px;
      box-shadow:0 8px 24px rgba(11,53,102,.12);
      z-index:60;
      max-height:260px;
      overflow:auto;
      padding:6px;
      display:none;
    }
    .permissions-page .suggest-item{
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;border-radius:8px;cursor:pointer;
      color:#0f172a;font-size:14px;
    }
    .permissions-page .suggest-item:hover{background:#f5f8fc}
    .permissions-page .suggest-empty{padding:12px;color:#6b7280;font-size:13px}
    .permissions-page .badge-count{margin-left:8px;background:#eef2ff;color:#1e3a8a;font-weight:700;border-radius:9999px;padding:2px 8px;font-size:12px}

    /* Hide native multi-select but keep in DOM for form submit */
    .permissions-page .hidden-select{position:absolute !important; left:-9999px !important; width:1px; height:1px; opacity:0;}

    /* Inline actions inside input container */
  .permissions-page .inline-actions{position:absolute; right:8px; top:50%; transform:translateY(-50%); display:flex; align-items:center; gap:6px}
  .permissions-page .btn-inline{height:44px; padding:0 12px; border:1px solid #d1d5db; background:#f8fafc; color:#334155; border-radius:8px; font-size:13px; cursor:pointer}
    .permissions-page .btn-inline:hover{background:#eef2f7}

  .permissions-page .inline-row{display:flex; align-items:center; gap:10px}

    /* Pulse highlight when navigating to a module */
    .permissions-page .pulse-highlight{animation:pulse-h 1.2s ease 1}
    @keyframes pulse-h{0%{box-shadow:0 0 0 0 rgba(30,96,177,.45)}70%{box-shadow:0 0 0 8px rgba(30,96,177,0)}100%{box-shadow:0 0 0 0 rgba(30,96,177,0)}}
    
    .permissions-page .toolbar-field select::placeholder,
    .permissions-page .toolbar-field input::placeholder{
      color:#9ca3af;
      font-weight:400;
    }
    
    .permissions-page .toolbar-field select:focus,
    .permissions-page .toolbar-field input:focus{
      border-color:#3b82f6;
      background:#ffffff;
      box-shadow:0 0 0 3px rgba(59, 130, 246, 0.1), 0 1px 2px rgba(0,0,0,0.05);
    }
    
    .permissions-page .toolbar-field select:focus + .input-icon,
    .permissions-page .toolbar-field input:focus + .input-icon{
      color:#3b82f6;
    }
    
    .permissions-page .toolbar-field select:hover,
    .permissions-page .toolbar-field input:hover{
      border-color:#9ca3af;
      box-shadow:0 1px 3px rgba(0,0,0,0.1);
    }
    
    /* Allow all fields to flex evenly across grid */
    .permissions-page .org-type-field,
    .permissions-page .org-role-field,
    .permissions-page .user-toolbar-field{ min-width:0; max-width:none; }
    
    .permissions-page .user-toolbar-field .user-filter-input{
      margin-bottom:6px;
      height:38px;
    }
    
    .permissions-page .user-toolbar-field .user-select{
      height:38px;
      font-size:13px;
    }
    
    .permissions-page .user-toolbar-field .user-actions{
      display:flex;
      align-items:center;
      gap:8px;
      margin-top:4px;
    }
    
    .permissions-page .user-toolbar-field .btn-micro{
      padding:4px 8px;
      font-size:11px;
      border-radius:6px;
      height:24px;
      line-height:1;
      background:#f3f4f6;
      border:1px solid #d1d5db;
      color:#374151;
      transition:all 0.2s ease;
    }
    
    .permissions-page .user-toolbar-field .btn-micro:hover{
      background:#e5e7eb;
      border-color:#9ca3af;
    }
    
    .permissions-page .user-toolbar-field .hint{
      font-size:10px;
      color:#9ca3af;
      line-height:1.2;
    }
    
    /* Search field styling - flex-grow to take remaining space */
    .permissions-page .search-toolbar-field{
      flex:1 1 auto;
      min-width:240px;
    }
    
    .permissions-page .search-toolbar-field .search-container{
      position:relative;
    }
    
    .permissions-page .search-toolbar-field input{
      padding-right:44px;
    }
    
    .permissions-page .search-clear{
      position:absolute;
      right:12px;
      top:50%;
      transform:translateY(-50%);
      background:none;
      border:none;
      color:#9ca3af;
      cursor:pointer;
      font-size:18px;
      padding:6px;
      border-radius:4px;
      transition:all 0.2s ease;
    }
    
    .permissions-page .search-clear:hover{
      color:#3b82f6;
      background:rgba(59, 130, 246, 0.1);
    }
    
    /* Save button styling - primary blue, bold, slightly larger */
    .permissions-page .toolbar-save-btn{
      height:44px;
      padding:0 24px;
      border-radius:8px;
      font-size:14px;
      font-weight:700;
      background:linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color:#ffffff;
      border:none;
      cursor:pointer;
      transition:all 0.2s ease;
      display:flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
      box-shadow:0 1px 3px rgba(0,0,0,0.1);
      min-width:140px;
      justify-content:center;
    }
    
    .permissions-page .toolbar-save-btn:hover{
      background:linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      transform:translateY(-1px);
      box-shadow:0 4px 12px rgba(59, 130, 246, 0.3);
    }
    
    .permissions-page .toolbar-save-btn:active{
      transform:translateY(0);
    }
    
    .permissions-page .toolbar-save-btn i{
      font-size:14px;
    }
    
    /* Responsive design for better spacing */
    @media (max-width: 1400px){
      .permissions-page .toolbar-filter{
        grid-template-columns:180px 200px 220px 1fr auto;
        gap:12px 20px;
        padding:18px 20px;
      }
    }
    
    @media (max-width: 1200px){
      .permissions-page .toolbar-filter{
        grid-template-columns:160px 180px 200px 1fr auto;
        gap:12px 16px;
        padding:16px 18px;
      }
      
      .permissions-page .toolbar-field{
        min-width:160px;
      }
      
      .permissions-page .toolbar-field select,
      .permissions-page .toolbar-field input{
        min-width:160px;
      }
    }
    
    @media (max-width: 980px){
      .permissions-page .toolbar-filter{
        grid-template-columns:1fr 1fr; /* two neat columns */
        grid-auto-rows:auto;
        gap:16px 20px;
        align-items:end;
      }
      .permissions-page .org-type-field{grid-column:1}
      .permissions-page .org-role-field{grid-column:2}
      .permissions-page .user-toolbar-field{grid-column:1 / -1}
      .permissions-page .search-toolbar-field{grid-column:1}
      .permissions-page .toolbar-save-btn{grid-column:2; justify-self:end; min-width:180px}
    }
    
    @media (max-width: 640px){
      .permissions-page .toolbar-filter{
        grid-template-columns:1fr;
        gap:12px;
        padding:16px;
      }
      
      .permissions-page .toolbar-field{
        min-width:auto;
      }
      
      .permissions-page .toolbar-field select,
      .permissions-page .toolbar-field input{
        min-width:auto;
      }
      
      .permissions-page .toolbar-save-btn{
        min-width:100%;
      }
    }

    /* Wrap the two lists + action column */
    .permissions-page .panel-grid{
      display:grid;grid-template-columns:1fr auto 1fr;gap:20px;margin:10px 0;
      min-height:500px;
    }
    @media (max-width: 980px){ 
      .permissions-page .panel-grid{grid-template-columns:1fr;gap:15px} 
      .permissions-page .actions-col{flex-direction:row;justify-content:center;flex-wrap:wrap}
    }

    /* Panels look/feel like cards in master page */
    .permissions-page .panel{
      background:var(--surf);border:1px solid var(--border);border-radius:16px;box-shadow:0 4px 12px rgba(0,0,0,0.1);
      display:flex;flex-direction:column;height:500px;
    }
    .permissions-page .panel .panel-head{
      background:linear-gradient(135deg,var(--primary) 0%, var(--primary-dark) 100%);color:#fff;
      padding:12px 16px;border-top-left-radius:16px;border-top-right-radius:16px;
      display:flex;justify-content:space-between;align-items:center;font-weight:800;text-transform:uppercase;font-size:13px;letter-spacing:.6px;
      box-shadow:0 2px 4px rgba(0,0,0,0.1);
    }
    .permissions-page .panel .panel-head .count{background:rgba(255,255,255,.3);padding:4px 10px;border-radius:20px;font-weight:800;font-size:12px}

    /* Lists: only these scroll, nothing else */
    .permissions-page .list{
      overflow-y:auto; 
      padding:8px 12px;
      flex:1;
      background:#fafbfc;
    }

    .permissions-page .item{
      display:flex;gap:12px;align-items:flex-start;padding:12px;border:1px solid #e1e8ed;
      border-radius:10px;background:#fff;margin:6px 0;cursor:pointer;transition:all .2s ease;
      position:relative;
    }
    .permissions-page .item:hover{
      box-shadow:0 2px 8px rgba(20, 76, 141, 0.15);
      border-color:var(--primary);
      transform:translateY(-1px);
    }
    .permissions-page .item.selected{
      background:linear-gradient(135deg, #e3f2fd 0%, #f1f8ff 100%);
      border-color:var(--primary);
      box-shadow:0 2px 8px rgba(20, 76, 141, 0.2);
    }
    .permissions-page .item .chk{width:18px;height:18px;margin-top:2px;accent-color:var(--primary);cursor:pointer}
    .permissions-page .item .name{font-weight:700;color:var(--ink);font-size:14px;line-height:1.3}
    .permissions-page .item .desc{font-size:12px;color:var(--muted);margin-top:3px;line-height:1.2}

    /* Folder/Parent items styling */
    .permissions-page .item.folder{
      background:linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);
      border-left:4px solid var(--primary);
    }
    .permissions-page .item.folder:hover{
      background:linear-gradient(135deg, #f0f4ff 0%, #fafbff 100%);
    }
    .permissions-page .item.folder .folder-icon{
      color:var(--primary);
      font-size:16px;
      margin-right:4px;
    }
    /* Removed partial folder variants */

    /* Children indentation */
    .permissions-page .children{
      margin-left:30px;
      margin-top:8px;
      border-left:2px solid #e1e8ed;
      padding-left:12px;
    }
    .permissions-page .children .item{
      margin-left:0;
      position:relative;
    }
    .permissions-page .children .item::before{
      content:'';
      position:absolute;
      left:-12px;
      top:50%;
      width:10px;
      height:1px;
      background:#e1e8ed;
    }

    /* Middle column actions styled like master buttons */
    .permissions-page .actions-col{
      display:flex;flex-direction:column;gap:10px;align-items:stretch;justify-content:center;
      min-width:140px;
      padding:0 5px;
    }
    .permissions-page .actions-col .btn{
      border-radius:10px;
      padding:10px 16px;
      font-weight:600;
      font-size:13px;
      transition:all .2s ease;
      border:2px solid transparent;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
    }
    .permissions-page .actions-col .btn:hover{
      transform:translateY(-1px);
      box-shadow:0 4px 12px rgba(0,0,0,0.15);
    }
    .permissions-page .actions-col .btn-primary{
      background:linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      border-color:var(--primary);
    }
    .permissions-page .actions-col .btn-primary:hover{
      background:linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
    }
    .permissions-page .actions-col .btn-secondary{
      background:linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
      border-color:#6c757d;
      color:#fff;
    }
    .permissions-page .actions-col .btn-secondary:hover{
      background:linear-gradient(135deg, #5a6268 0%, #495057 100%);
    }
    .permissions-page .actions-col .btn:disabled{
      opacity:0.5;
      cursor:not-allowed;
      transform:none;
    }
    .permissions-page .actions-col .btn:disabled:hover{
      transform:none;
      box-shadow:none;
    }

    /* Stats strip compact */
    .permissions-page .stats{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin:12px 0;
    }
    .permissions-page .stat{
      background:linear-gradient(135deg, var(--surf) 0%, #ffffff 100%);
      border:1px solid var(--border);
      border-radius:12px;
      box-shadow:0 2px 6px rgba(0,0,0,0.08);
      padding:14px;
      text-align:center;
      transition:all .2s ease;
    }
    .permissions-page .stat:hover{
      transform:translateY(-1px);
      box-shadow:0 4px 12px rgba(0,0,0,0.12);
    }
    .permissions-page .stat .num{font-weight:900;color:var(--primary);font-size:20px;line-height:1}
    .permissions-page .stat .lbl{color:var(--muted);font-size:12px;margin-top:4px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px}

    /* Save bar */
    .permissions-page .savebar{
      display:flex;justify-content:space-between;align-items:center;margin-top:15px;padding-top:15px;border-top:2px solid var(--border);
      background:var(--surf);
      padding:15px;
      border-radius:12px;
      box-shadow:0 2px 6px rgba(0,0,0,0.08);
    }
    .permissions-page .savebar .save-btn{border-radius:10px;padding:12px 24px;font-weight:600}

    /* Tiny helpers */
  .permissions-page .search-bar{display:flex;align-items:center;gap:8px;background:#f1f5f9;border:1px solid var(--border);border-radius:9999px;padding:6px 10px}
  .permissions-page .search-bar input{min-width:220px;border:none;background:transparent;outline:none}
  .permissions-page .search-bar i{color:var(--muted)}
  .permissions-page .search-bar .search-clear{background:transparent;border:none;color:var(--muted)}
    .permissions-page .empty{padding:24px;color:var(--muted);text-align:center}

    /* Dropdown/input polish for filters (pill look) */
    .permissions-page .filters-left .filter select,
    .permissions-page .filters-left .filter input,
    .permissions-page .controls-center .filter input,
    .permissions-page .controls-center .filter select{
      font-size:14px;line-height:1.4;padding:8px 12px;border:1px solid var(--border);border-radius:9999px;max-width:280px;background:#fff
    }
    .permissions-page .filters-left .filter select:focus,
    .permissions-page .filters-left .filter input:focus,
    .permissions-page .controls-center .filter input:focus,
    .permissions-page .controls-center .filter select:focus{outline:none;border-color:var(--primary)}
    .permissions-page .filters-left .filter{display:flex;flex-direction:column;gap:6px;margin-right:12px}
  .permissions-page .main-actions .btn{border-radius:9999px;padding:8px 14px}
    .permissions-page .empty{
      padding:40px 24px;
      color:var(--muted);
      text-align:center;
      background:linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
      border-radius:12px;
      margin:20px 0;
      border:2px dashed #dee2e6;
    }
  </style>
{% endblock %}

{% block content %}
<div class="ems-dashboard mdm-page permissions-page">
  <!-- Heading (black, compact) -->
  <header class="topbar">
    <div><h1>Sidebar Permissions Management</h1></div>
  </header>

  <!-- Professional toolbar-style filter -->
  <div class="controls-container">
    <div class="toolbar-filter">
      <!-- Organization Type - w-1/5 equivalent -->
      <div class="toolbar-field org-type-field">
        <label>Organization Type</label>
        <div class="toolbar-input-container">
          <i class="fas fa-building input-icon"></i>
          <select id="orgTypeSelect" aria-label="Organization Type">
            <option value="">All Types</option>
            {% for t in organization_types %}
              <option value="{{ t.id }}" {% if selected_org_type == t.id|stringformat:'s' %}selected{% endif %}>{{ t.name }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <!-- Organization Role - w-1/4 equivalent -->
      <div class="toolbar-field org-role-field">
        <label>Organization Role</label>
        <div class="toolbar-input-container">
          <i class="fas fa-user-tag input-icon"></i>
          <select id="orgRoleSelect" aria-label="Organization Role">
            <option value="">All Roles</option>
            {% for r in org_roles %}
              <option value="{{ r.id }}" {% if selected_org_role == r.id|stringformat:'s' %}selected{% endif %}>{{ r.name }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <!-- Users - single-row with combobox suggestions -->
      <div class="toolbar-field user-toolbar-field">
        <label>Users</label>
        <div class="toolbar-input-container inline-row" style="position:relative">
          <i class="fas fa-users input-icon"></i>
          <input type="text" id="userFilter" class="user-filter-input" placeholder="Search users…" autocomplete="off" aria-expanded="false" aria-haspopup="listbox">
          <button type="button" id="clearUserBtn" class="btn-inline" title="Clear user">Clear</button>
          <div id="userSuggest" class="suggest-dropdown" role="listbox" aria-label="User suggestions"></div>
        </div>
        <!-- Hidden multi-select preserved for submission -->
        <select id="userSelect" name="users" multiple aria-label="Users" class="hidden-select">
          {% for u in users %}
            <option value="{{ u.id }}" {% if selected_user == u.id|stringformat:'s' %}selected{% endif %}>{{ u.name }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Search Modules - flex-grow to take remaining space -->
      <div class="toolbar-field search-toolbar-field">
        <label>Search Modules</label>
        <div class="search-container" style="position:relative">
          <i class="fas fa-search input-icon"></i>
          <input id="globalSearch" type="text" placeholder="Search modules and permissions…" autocomplete="off" aria-label="Search modules" aria-expanded="false" aria-haspopup="listbox">
          <button class="search-clear" type="button" id="clearSearchBtn" title="Clear search">×</button>
          <div id="moduleSuggest" class="suggest-dropdown" role="listbox" aria-label="Module suggestions"></div>
        </div>
      </div>

      <!-- Save Button - aligned right, primary blue, bold -->
      <button type="submit" form="permissionsForm" id="saveBtn" class="toolbar-save-btn">
        <i class="fas fa-save"></i>
        <span id="saveText">Save Changes</span>
        <i id="saveSpinner" class="fas fa-spinner fa-spin" style="display:none"></i>
      </button>
    </div>
  </div>

  <!-- Stats -->
  <div class="stats">
    <div class="stat"><div class="num" id="availableCount">0</div><div class="lbl">Available</div></div>
    <div class="stat"><div class="num" id="assignedCount">0</div><div class="lbl">Assigned</div></div>
    <div class="stat"><div class="num" id="selectedCount">0</div><div class="lbl">Selected</div></div>
  </div>

  <!-- Form & Panels -->
  <form id="permissionsForm" method="post" action="{% url 'admin_sidebar_permissions' %}">
    {% csrf_token %}
    <input type="hidden" name="assigned_order" id="assigned_order" value="[]">
  <input type="hidden" name="role" id="hidden_role" value="{{ selected_org_role|default:selected_role|default:'' }}">

    <!-- Loading / Saving Overlays (hidden by default) -->
    <div id="loadingOverlay" class="screen-overlay" style="display:none">
      <div class="overlay-card">
        <div class="spinner" aria-hidden="true"></div>
        <div class="message">Loading data…</div>
        <div style="font-size:12px;color:#5377a3;font-weight:500">Please wait</div>
      </div>
    </div>
    <div id="savingOverlay" class="screen-overlay saving" style="display:none">
      <div class="overlay-card">
        <div class="spinner" aria-hidden="true"></div>
        <div class="message">Saving changes…</div>
        <div style="font-size:12px;color:#2d6d46;font-weight:500">Applying sidebar updates</div>
      </div>
    </div>

    <div class="panel-grid">
      <!-- Available -->
      <section class="panel">
        <div class="panel-head">
          <span>Available Permissions</span>
          <span class="count" id="availableBadge">0</span>
        </div>
        <div class="list" id="availableList">
          <div class="empty" id="availableEmpty">No permissions available</div>
        </div>
      </section>

      <!-- Middle actions -->
      <div class="actions-col">
        <button type="button" id="addBtn" class="btn btn-primary"><i class="fas fa-arrow-right"></i> Add</button>
        <button type="button" id="removeBtn" class="btn btn-primary"><i class="fas fa-arrow-left"></i> Remove</button>
        <button type="button" id="moveUpBtn" class="btn btn-secondary"><i class="fas fa-arrow-up"></i> Move Up</button>
        <button type="button" id="moveDownBtn" class="btn btn-secondary"><i class="fas fa-arrow-down"></i> Move Down</button>
        <button type="button" id="selectAllBtn" class="btn btn-secondary"><i class="fas fa-check-double"></i> Select All</button>
        <button type="button" id="clearBtn" class="btn btn-secondary"><i class="fas fa-times"></i> Clear</button>
      </div>

      <!-- Assigned -->
      <section class="panel">
        <div class="panel-head">
          <span>Assigned Permissions</span>
          <span class="count" id="assignedBadge">0</span>
        </div>
        <div class="list" id="assignedList">
          <div class="empty" id="assignedEmpty">No permissions assigned</div>
        </div>
      </section>
    </div>

    <!-- Change indicator bar removed per latest request -->
  </form>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const $ = (sel) => document.querySelector(sel);
    const showOverlay = (id, show=true)=>{ const el=$('#'+id); if(el) el.style.display = show? 'flex':'none'; };
    // Show initial loading while we render the tree (in case of big data) – will hide after first render
    showOverlay('loadingOverlay', true);
    
  // Populate initial view based on selection present in the query (role/user)
  setTimeout(()=>{ fetchAssignedForCurrentSelection(); }, 0);

  // --- User combobox: search-as-you-type suggestions ---
    const userFilter = $('#userFilter');
    const userSelectHidden = $('#userSelect');
    const userSuggest = $('#userSuggest');
    function listUsers() {
      return Array.from(userSelectHidden.options).map(o=>({id:o.value, name:o.textContent||''}));
    }
    function selectedUserIds() {
      return new Set(Array.from(userSelectHidden.selectedOptions).map(o=>o.value));
    }
    function renderUserSuggestions(term) {
      if(!userSuggest) return;
      const q = (term||'').toLowerCase();
      const sel = selectedUserIds();
      const matches = listUsers().filter(u => !q || u.name.toLowerCase().includes(q)).slice(0, 50);
      userSuggest.innerHTML = '';
      if(matches.length === 0){
        userSuggest.innerHTML = '<div class="suggest-empty">No users found</div>';
      } else {
        for(const u of matches){
          const div = document.createElement('div');
          div.className = 'suggest-item';
          div.setAttribute('role','option');
          div.dataset.id = u.id;
          div.innerHTML = `<i class="fas fa-user-circle" style="color:#1e60b1"></i><span>${u.name}</span>${sel.has(u.id)?'<span class="badge-count">Selected</span>':''}`;
          div.addEventListener('click', async () => {
            // Single-select: choose this user and fetch assigned permissions
            const opt = Array.from(userSelectHidden.options).find(o=>o.value===u.id);
            if(opt){
              Array.from(userSelectHidden.options).forEach(o=>o.selected=false);
              opt.selected = true;
              await fetchAssignedForCurrentSelection();
            }
            hideUserSuggestions();
          });
          userSuggest.appendChild(div);
        }
      }
      userSuggest.style.display = 'block';
      userFilter.setAttribute('aria-expanded','true');
    }
    function hideUserSuggestions(){ if(userSuggest){ userSuggest.style.display='none'; } userFilter?.setAttribute('aria-expanded','false'); }
    if(userFilter){
      userFilter.addEventListener('input', ()=> renderUserSuggestions(userFilter.value));
      userFilter.addEventListener('focus', ()=> renderUserSuggestions(userFilter.value));
      document.addEventListener('click', (e)=>{ if(!e.target.closest('.user-toolbar-field')) hideUserSuggestions(); });
    }

    // (Removed) Select-All users button
    // Clear user selection button
    const clearUserBtn = $('#clearUserBtn');
    if(clearUserBtn){
      clearUserBtn.addEventListener('click', ()=>{
        if(userFilter) userFilter.value='';
        if(userSelectHidden) Array.from(userSelectHidden.options).forEach(o=>o.selected=false);
        const roleEl = $('#orgRoleSelect');
        if(roleEl && roleEl.value){
          fetchAssignedForCurrentSelection();
        } else {
          assigned = [];
          available = buildAvailableList(fullNavTree, assigned);
          render();
        }
        hideUserSuggestions();
      });
    }

    // Fetch assigned permissions for selected user and rebuild panels
    async function fetchAssignedForCurrentSelection(){
      try{
        const selUsers = Array.from(userSelectHidden.selectedOptions).map(o=>o.value).filter(Boolean);
        const roleEl = $('#orgRoleSelect');
        const roleId = roleEl ? (roleEl.value||'') : '';
        const orgTypeEl = $('#orgTypeSelect');
        const orgEl = $('#orgSelect');
        // Priority: specific user -> by role -> none (blank)
        let url = null;
        if(selUsers.length === 1){
          // Show direct assignments for a specific user
          url = `${'{% url "api_get_sidebar_permissions" %}'}?user=${encodeURIComponent(selUsers[0])}&effective=0`;
        } else if(roleId){
          // First try direct-only entries for this role id
          const base = `{% url "api_get_sidebar_permissions" %}`;
          const qp0 = new URLSearchParams();
          qp0.set('role', roleId);
          qp0.set('effective', '0');
          if(orgTypeEl && orgTypeEl.value) qp0.set('org_type', orgTypeEl.value);
          if(orgEl && orgEl.value) qp0.set('organization', orgEl.value);
          url = `${base}?${qp0.toString()}`;
        }

        if(!url){
          assigned = [];
          available = buildAvailableList(fullNavTree, assigned);
          render();
          return;
        }

        showOverlay('loadingOverlay', true);
        let serverIds = [];
        async function doFetch(u){
          const r = await fetch(u, {headers:{'X-Requested-With':'fetch'}});
          if(r.ok){
            const data = await r.json();
            return Array.isArray(data.assignments) ? data.assignments : [];
          }
          return [];
        }
        serverIds = await doFetch(url);
        // Fallback: if role-based direct-only is empty, try effective=1 merged
        if(serverIds.length === 0 && !selUsers.length && roleId){
          const qp1 = new URLSearchParams();
          qp1.set('role', roleId);
          qp1.set('effective', '1');
          if(orgTypeEl && orgTypeEl.value) qp1.set('org_type', orgTypeEl.value);
          if(orgEl && orgEl.value) qp1.set('organization', orgEl.value);
          const url1 = `{% url "api_get_sidebar_permissions" %}?${qp1.toString()}`;
          serverIds = await doFetch(url1);
        }
        if(window && window.console){ try{ console.debug('[permissions] fetched', {user: selUsers[0]||null, role: roleId||null, count: serverIds.length}); }catch(_e){} }
        const freshSet = new Set(serverIds);
        function pickAssigned(items){
          const out = [];
          for(const it of items){
            const ch = it.children && it.children.length ? pickAssigned(it.children) : [];
            if(ch.length){ out.push({id: it.id, label: it.label, children: ch}); }
            else if(freshSet.has(it.id)) { out.push({id: it.id, label: it.label}); }
          }
          return out;
        }
        assigned = pickAssigned(fullNavTree);
        available = buildAvailableList(fullNavTree, assigned);
        // update baseline for change indicator
        assignedData = JSON.parse(JSON.stringify(assigned));
        selectedAvailable.clear();
        selectedAssigned.clear();
        render();
      }catch(e){
        console.error('Failed to fetch assigned permissions', e);
      } finally{
        showOverlay('loadingOverlay', false);
      }
    }
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));

    // --- Module suggestions under globalSearch ---
    const moduleSuggest = $('#moduleSuggest');
    function flattenModulesForSuggest(list){
      const out = [];
      for(const item of list||[]){
        if(item.children && item.children.length){
          out.push({ id: item.id, label: item.label, isParent: true });
          for(const c of item.children){ out.push({ id: c.id, label: `${item.label} › ${c.label}`, parentId: item.id, isParent:false }); }
        } else {
          out.push({ id: item.id, label: item.label, isParent:false });
        }
      }
      return out;
    }
    function renderModuleSuggestions(term){
      if(!moduleSuggest) return;
      const q = (term||'').toLowerCase();
      const all = flattenModulesForSuggest(available.concat(assigned));
      const matches = all.filter(m=>!q || (m.label||'').toLowerCase().includes(q)).slice(0, 50);
      moduleSuggest.innerHTML = '';
      if(matches.length===0){
        moduleSuggest.innerHTML = '<div class="suggest-empty">No modules found</div>';
      } else {
        for(const m of matches){
          const div = document.createElement('div');
          div.className = 'suggest-item';
          div.setAttribute('role','option');
          div.dataset.id = m.id;
          div.innerHTML = `<i class="fas ${m.isParent?'fa-folder':'fa-cube'}" style="color:#1e60b1"></i><span>${m.label}</span>`;
          div.addEventListener('click', ()=>{
            // Quick action: select the leaf if available, or expand/focus in lists
            const leafEl = document.querySelector(`[data-id="${CSS.escape(m.id)}"]`);
            if(leafEl){
              leafEl.scrollIntoView({behavior:'smooth', block:'center'});
              leafEl.classList.add('pulse-highlight');
              setTimeout(()=> leafEl.classList.remove('pulse-highlight'), 1200);
            } else {
              showToast('Item not currently visible. Try expanding folders or clearing filters.', 'error');
            }
            moduleSuggest.style.display='none';
            $('#globalSearch')?.setAttribute('aria-expanded','false');
          });
          moduleSuggest.appendChild(div);
        }
      }
      moduleSuggest.style.display='block';
      $('#globalSearch')?.setAttribute('aria-expanded','true');
    }

    function showToast(message, type='success'){
      const t=document.createElement('div');t.className=`toast ${type}`;t.textContent=message;
      Object.assign(t.style,{position:'fixed',right:'14px',bottom:'14px',background:'#164c8d',color:'#fff',padding:'10px 12px',borderRadius:'10px',boxShadow:'0 12px 40px rgba(2,6,23,.2)',opacity:'0',transform:'translateY(10px)',transition:'.25s',zIndex:1000,fontWeight:800});
      document.body.appendChild(t); setTimeout(()=>{t.style.opacity='1';t.style.transform='none'},50);
      setTimeout(()=>{t.style.opacity='0';t.style.transform='translateY(10px)';setTimeout(()=>t.remove(),250)},2500);
    }

    const availableData = JSON.parse('{{ available_permissions|safe|escapejs }}'.replace(/&quot;/g,'"') || '[]');
let assignedData  = JSON.parse('{{ assigned_permissions|safe|escapejs }}'.replace(/&quot;/g,'"') || '[]');

// 🔹 Merge two permission trees (by id), preserving order and children
function mergeTrees(a = [], b = []){
  const byId = new Map();

  function cloneShallow(n){
    return {
      id: n.id,
      label: n.label,
      description: n.description || '',
      children: n.children && n.children.length ? [] : undefined
    };
  }

  function mergeNode(target, source){
    if (!source) return target;
    // merge label/description only if missing on target
    if (!target.label && source.label) target.label = source.label;
    if (!target.description && source.description) target.description = source.description;
    const tChildren = target.children || [];
    const sChildren = source.children || [];
    if (!tChildren.length && !sChildren.length){
      target.children = undefined;
      return target;
    }
    const childMap = new Map(tChildren.map(c => [c.id, c]));
    for (const sc of sChildren){
      if (!childMap.has(sc.id)) childMap.set(sc.id, cloneShallow(sc));
      const merged = mergeNode(childMap.get(sc.id), sc);
      childMap.set(sc.id, merged);
    }
    target.children = Array.from(childMap.values());
    return target;
  }

  function addList(list){
    for (const n of list){
      if (!byId.has(n.id)) byId.set(n.id, cloneShallow(n));
      const merged = mergeNode(byId.get(n.id), n);
      byId.set(n.id, merged);
    }
  }

  addList(a);
  addList(b);

  // preserve top-level order: first from a then b for any new ids
  const order = [...(a||[]).map(x=>x.id), ...(b||[]).map(x=>x.id)];
  const seen = new Set();
  const out = [];
  for (const id of order){
    if (seen.has(id)) continue;
    const node = byId.get(id);
    if (node){ out.push(node); seen.add(id); }
  }
  // Append any remaining nodes not in order (edge-case)
  for (const [id,node] of byId){ if(!seen.has(id)) out.push(node); }
  return out;
}

// 🔹 Helper: build available list preserving hierarchy until ALL descendants are assigned
function buildAvailableList(originalData = [], assigned = []) {
  // 1) Collect ONLY assigned leaf IDs (do not mark parents as assigned unless all leaves are)
  const assignedLeafIds = new Set();
  (function collectLeaves(list){
    for(const item of (list || [])){
      if(item && item.children && item.children.length){
        collectLeaves(item.children);
      } else if (item && item.id) {
        assignedLeafIds.add(item.id);
      }
    }
  })(assigned);

  // 2) Clone original tree including ONLY nodes that still have at least one unassigned descendant
  function cloneWithRemaining(item){
    if(!item) return null;
    const hasChildren = Array.isArray(item.children) && item.children.length > 0;
    if(hasChildren){
      const keptChildren = [];
      for(const child of item.children){
        const clonedChild = cloneWithRemaining(child);
        if(clonedChild) keptChildren.push(clonedChild);
      }
      if(keptChildren.length === 0) return null; // all descendants assigned → hide parent
      return {
        id: item.id,
        label: item.label,
        description: item.description || '',
        children: keptChildren
      };
    }
    // Leaf
    return assignedLeafIds.has(item.id) ? null : {
      id: item.id,
      label: item.label,
      description: item.description || ''
    };
  }

  return (originalData || []).map(cloneWithRemaining).filter(Boolean);
}

// Build a full tree so removed items reappear in Available
const fullNavTree = mergeTrees(availableData, assignedData);
let available = buildAvailableList(fullNavTree, assignedData);
let assigned  = JSON.parse(JSON.stringify(assignedData));

let selectedAvailable = new Set(); 
let selectedAssigned  = new Set();
let lastSavedLeafIds = null;


    const availableList = $('#availableList');
    const assignedList  = $('#assignedList');
    const availableCount=$('#availableCount');
    const assignedCount =$('#assignedCount');
    const selectedCount =$('#selectedCount');
    const availableEmpty=$('#availableEmpty');
    const assignedEmpty =$('#assignedEmpty');
    const globalSearch  =$('#globalSearch');
  const userSelect=$('#userSelect');
  const selectAllUsersBtn=null; // removed
    const orgTypeSelect=$('#orgTypeSelect');
  const orgSelect=$('#orgSelect');
    const orgRoleSelect=$('#orgRoleSelect');
  const changeIndicator=$('#changeIndicator'); // may be null (indicator removed)

    const addBtn=$('#addBtn'), removeBtn=$('#removeBtn'),
          moveUpBtn=$('#moveUpBtn'), moveDownBtn=$('#moveDownBtn'),
          selectAllBtn=$('#selectAllBtn'), clearBtn=$('#clearBtn');

    // Helper function to flatten nested permission structure
    function flatten(list) {
      let result = [];
      for (const item of list) {
        if (item.children && item.children.length > 0) {
          result = result.concat(flatten(item.children));
        } else {
          result.push(item);
        }
      }
      return result;
    }

    function reloadWithFilters(extraParams={}) {
      const params=new URLSearchParams(window.location.search);
      const setOrDelete=(k,v)=>{ if(v){params.set(k,v)} else {params.delete(k)} };
  setOrDelete('org_type', orgTypeSelect?orgTypeSelect.value:'');
  setOrDelete('organization', orgSelect?orgSelect.value:'');
  const selUsers=Array.from(userSelect.selectedOptions).map(o=>o.value).filter(Boolean);
  setOrDelete('user', selUsers.length===1?selUsers[0]:'');
  setOrDelete('role', orgRoleSelect?orgRoleSelect.value:'');
      for(const [k,v] of Object.entries(extraParams)) setOrDelete(k,v);
      const current = window.location.search.replace(/^\?/,'');
      const next = params.toString();
      if (next !== current) {
        window.location.search = next ? ('?'+next) : '';
      }
    }

    // Helpers for clean labels
    function toTitleCase(str){
      if(!str) return '';
      return str.replace(/\w\S*/g,(w)=>/^(?:[A-Z]{2,}|[IVXLCM]+)$/.test(w)?w:w[0].toUpperCase()+w.slice(1).toLowerCase());
    }
    function cleanOrgName(name){
      if(!name) return '';
      return name.replace(/\s*\((?:Department|School|Center|Centre)\)\s*$/i,'').trim();
    }
    function dedupeByName(items){
      const seen=new Set();
      return items.filter(r=>{
        const k=(r.name||'').trim().toLowerCase();
        if(seen.has(k)) return false; seen.add(k); return true;
      });
    }

    async function fetchJson(url){
      const r=await fetch(url,{headers:{'X-Requested-With':'fetch'}});
      if(!r.ok) throw new Error('HTTP '+r.status);
      return r.json();
    }

    async function populateOrganizations({triggerChange=true}={}){
      if(!orgTypeSelect || !orgSelect) return; // guard: orgSelect may not exist in this layout
      const typeId = orgTypeSelect.value;
      const search = new URLSearchParams(window.location.search);
      const selectedOrg = search.get('organization') || '';
      orgSelect.innerHTML = '<option value="">All Organizations</option>';
      if(!typeId){ if(triggerChange) orgSelect.dispatchEvent(new Event('change')); return; }
      try{
        const data = await fetchJson(`/core-admin/api/org-type/${typeId}/organizations/`);
        const orgs = (data.organizations||[]).slice().sort((a,b)=>a.name.localeCompare(b.name));
        orgs.forEach(o=>{
          const opt=document.createElement('option');
          opt.value=o.id; opt.textContent=o.name; if(String(o.id)===String(selectedOrg)) opt.selected=true; orgSelect.appendChild(opt);
        });
      }catch(e){ console.error('Failed to load organizations',e); }
      // trigger role refresh after orgs are ready (optional)
      if(triggerChange) orgSelect.dispatchEvent(new Event('change'));
    }

    async function populateRoles(){
      const orgId = orgSelect?orgSelect.value:'';
      orgRoleSelect.innerHTML = '';
      try{
        let data;
        if (orgId) {
          data = await fetchJson(`/core-admin/api/organization/${orgId}/roles/`);
        } else if (orgTypeSelect && orgTypeSelect.value) {
          data = await fetchJson(`/core-admin/api/org-type/${orgTypeSelect.value}/roles/`);
        } else {
          orgRoleSelect.appendChild(new Option('All Roles',''));
          return;
        }
        let roles = dedupeByName(data.roles||[]).map(r=>({id:r.id, name: toTitleCase(r.name)}));
        roles.sort((a,b)=>a.name.localeCompare(b.name));
        if(roles.length===0){
          const opt=new Option('No roles available',''); opt.disabled=true; opt.selected=true; orgRoleSelect.appendChild(opt);
        }else{
          orgRoleSelect.appendChild(new Option('All Roles',''));
          roles.forEach(r=> orgRoleSelect.appendChild(new Option(r.name, r.id)) );
        }
      }catch(e){
        console.error('Failed to load roles',e);
        const opt=new Option('No roles available',''); opt.disabled=true; opt.selected=true; orgRoleSelect.appendChild(opt);
      }
    }

    function getPermissionIcon(p){
      const map={
        dashboard:'fas fa-tachometer-alt',
        event:'fas fa-calendar-alt',
        user:'fas fa-users',
        report:'fas fa-chart-bar',
        analysis:'fas fa-chart-line',
        setting:'fas fa-cog',
        management:'fas fa-tools',
        cdl:'fas fa-paint-brush',
        po:'fas fa-graduation-cap',
        transcript:'fas fa-file-alt',
        graduate:'fas fa-user-graduate',
        certificate:'fas fa-certificate',
        academic:'fas fa-book',
        student:'fas fa-user-friends',
        faculty:'fas fa-chalkboard-teacher',
        admin:'fas fa-user-shield',
        course:'fas fa-book-open',
        exam:'fas fa-clipboard-list',
        grade:'fas fa-star',
        attendance:'fas fa-calendar-check',
        fee:'fas fa-dollar-sign',
  library:'fas fa-book',
        hostel:'fas fa-bed',
        transport:'fas fa-bus'
      };
      const label = (p.label || '').toLowerCase();
      const id = (p.id || '').toLowerCase();
      const key = Object.keys(map).find(k => label.includes(k) || id.includes(k));
      return map[key] || 'fas fa-cube';
    }

    // 🔹 Render item (parent = folder, leaf = checkbox)
function renderPermissionItem(p, isAssigned) {
  const div = document.createElement('div'); 
  div.className = 'item'; 
  div.dataset.id = p.id;
  // Identify dashboards for single-select rule (heuristic: id or label contains 'dashboard')
  const isDashboard = /dashboard/i.test(p.label || '') || /dashboard/i.test(p.id || '');
  if(isDashboard) div.dataset.dashboard = '1';

  if (p.children && p.children.length > 0) {
    // ----- Parent (folder with expand/collapse) -----
    div.classList.add('folder');
    // Partial state deprecated: entire group hidden when a child is assigned.
    
    div.innerHTML = `
      <i class="fas fa-folder folder-icon"></i>
      <div style="flex:1">
        <div class="name">${p.label}</div>
      </div>
      <i class="fas fa-chevron-down toggle-icon" style="color:var(--muted);font-size:12px;margin-left:auto"></i>
      <div class="children" style="display:block"></div>
    `;

    const childrenContainer = div.querySelector('.children');
    const toggleIcon = div.querySelector('.toggle-icon');
    
    p.children.forEach(child => {
      const childDiv = renderPermissionItem(child, isAssigned);
      childrenContainer.appendChild(childDiv);
    });

    // expand/collapse toggle
    div.addEventListener('click', e => {
      if (e.target.closest('.children')) return;
      const isVisible = childrenContainer.style.display !== 'none';
      childrenContainer.style.display = isVisible ? 'none' : 'block';
      toggleIcon.className = isVisible ? 'fas fa-chevron-right toggle-icon' : 'fas fa-chevron-down toggle-icon';
    });

  } else {
    // ----- Leaf (selectable with checkbox) -----
    const isSel = isAssigned ? selectedAssigned.has(p.id) : selectedAvailable.has(p.id);
    if (isSel) div.classList.add('selected');

    div.innerHTML = `
      <input type="checkbox" class="chk" ${isSel ? 'checked' : ''}>
      <i class="${getPermissionIcon(p)}" style="color:var(--primary);min-width:20px;font-size:16px"></i>
      <div style="flex:1">
        <div class="name">${p.label}</div>
        ${p.description ? `<div class="desc">${p.description}</div>` : ''}
      </div>
    `;

    // Click anywhere on item to toggle checkbox
    div.addEventListener('click', e => {
      const checkbox = div.querySelector('.chk');
      if (e.target !== checkbox) {
        checkbox.checked = !checkbox.checked;
        checkbox.dispatchEvent(new Event('change'));
      }
    });

    div.querySelector('.chk').addEventListener('change', e => {
      e.stopPropagation();
      const selected = isAssigned ? selectedAssigned : selectedAvailable;
      if (e.target.checked) {
        // Enforce single dashboard selection rule in its respective panel
        if(div.dataset.dashboard === '1'){
          // Uncheck any other dashboard in the same panel
            const panel = isAssigned ? '#assignedList' : '#availableList';
            Array.from(document.querySelectorAll(`${panel} .item[data-dashboard="1"] .chk`)).forEach(chk=>{
              if(chk!==e.target){ chk.checked=false; chk.dispatchEvent(new Event('change')); }
            });
        }
        selected.add(p.id);
        div.classList.add('selected');
      } else {
        selected.delete(p.id);
        div.classList.remove('selected');
      }
      updateUI();
    });
  }

  return div;
}

// 🔹 Collect only leaf IDs (ignores parents)
function collectLeafIds(list) {
  let result = [];
  for (const item of list) {
    if (item.children) {
      result = result.concat(collectLeafIds(item.children));
    } else {
      result.push(item.id);
    }
  }
  return result;
}

// 🔹 On Save → dump only leaf IDs into hidden field
document.getElementById('permissionsForm').addEventListener('submit', e => {
  // NOTE: For a user selection this list becomes a full override (whitelist) on backend.
  // Any role-derived items not present here are suppressed for that user.
  const selectedUsers = Array.from(userSelect.selectedOptions).map(o=>o.value).filter(Boolean);
  if (selectedUsers.length===0 && !(orgRoleSelect && orgRoleSelect.value)) {
    e.preventDefault();
    showToast('Please select a User or an Organization Role before saving.','error');
    return;
  }

  const leafIds = collectLeafIds(assigned);
  document.getElementById('assigned_order').value = JSON.stringify(leafIds);

  // ensure hidden role (org role id) is submitted
  const hiddenRole = document.getElementById('hidden_role');
  if (hiddenRole && orgRoleSelect) hiddenRole.value = orgRoleSelect.value || '';

  document.getElementById('saveText').textContent = 'Saving…';
  const sp = document.getElementById('saveSpinner'); 
  if (sp) sp.style.display = 'inline-block';
});
    function applyFilters(list){
      const q = globalSearch.value.trim().toLowerCase();
      if (!q) return list;
      
      function filterItem(item) {
        // Check if item name matches
        const nameMatches = item.label.toLowerCase().includes(q);
        
        if (item.children && item.children.length > 0) {
          // For parent items, check children recursively
          const filteredChildren = item.children
            .map(child => filterItem(child))
            .filter(child => child !== null);
          
          if (nameMatches || filteredChildren.length > 0) {
            // Return parent with filtered children (partial visual state removed in new logic)
            return {
              ...item,
              children: filteredChildren.length > 0 ? filteredChildren : item.children
            };
          }
        } else {
          // For leaf items, return if name matches
          if (nameMatches) return item;
        }
        
        return null;
      }
      
      return list
        .map(item => filterItem(item))
        .filter(item => item !== null);
    }

    function render(){
      const av=applyFilters(available); 
      const as=assigned;
      availableList.innerHTML=''; 
      assignedList.innerHTML='';
      if(av.length===0){ availableList.appendChild(availableEmpty.cloneNode(true)); }
      else av.forEach(p=>availableList.appendChild(renderPermissionItem(p,false)));
      if(as.length===0){ assignedList.appendChild(assignedEmpty.cloneNode(true)); }
      else as.forEach(p=>assignedList.appendChild(renderPermissionItem(p,true)));
      updateUI();
    }

    function updateUI(){
      // Count items properly (including children)
      const availableTotal = countItems(available);
      const assignedTotal = countItems(assigned);
      
      availableCount.textContent = availableTotal;
      assignedCount.textContent = assignedTotal;
      selectedCount.textContent = selectedAvailable.size + selectedAssigned.size;
      
      addBtn.disabled = selectedAvailable.size === 0;
      removeBtn.disabled = selectedAssigned.size === 0;
      moveUpBtn.disabled = selectedAssigned.size === 0;
      moveDownBtn.disabled = selectedAssigned.size === 0;

      // Compare by leaf IDs, not just top-level nodes
      const originalLeaves = collectLeafIds(assignedData).slice().sort().join(',');
      const currentLeaves = collectLeafIds(assigned).slice().sort().join(',');
      const changed = originalLeaves !== currentLeaves;
      if(changeIndicator){
        changeIndicator.textContent = changed ? 'Changes pending…' : 'No changes made';
        changeIndicator.style.color = changed ? '#b45309' : 'var(--muted)';
      }

      const ab = $('#availableBadge'), bb = $('#assignedBadge');
      if (ab) ab.textContent = availableTotal;
      if (bb) bb.textContent = assignedTotal;
    }

    // Helper function to count total items including children
    function countItems(list) {
      let count = 0;
      list.forEach(item => {
        if (item.children && item.children.length > 0) {
          count += countItems(item.children);
        } else {
          count += 1;
        }
      });
      return count;
    }

    // 🔹 Enhanced Add logic - properly sync between panels
    addBtn.addEventListener('click', () => {
      selectedAvailable.forEach(id => {
        // Find the item in available (could be child or standalone)
        let itemToMove = null;
        let parentContext = null;
        
        // First, check if it's a standalone item
        const standaloneIndex = available.findIndex(item => item.id === id && (!item.children || item.children.length === 0));
        if (standaloneIndex > -1) {
          itemToMove = available.splice(standaloneIndex, 1)[0];
          assigned.push(itemToMove);
        } else {
          // Look for it as a child item
          for (let parent of available) {
            if (parent.children) {
              const childIndex = parent.children.findIndex(c => c.id === id);
              if (childIndex > -1) {
                itemToMove = parent.children.splice(childIndex, 1)[0];
                parentContext = parent;
                
                // Find or create parent in assigned
                let assignedParent = assigned.find(a => a.id === parent.id);
                if (!assignedParent) {
                  assignedParent = { 
                    id: parent.id, 
                    label: parent.label, 
                    children: [] 
                  };
                  assigned.push(assignedParent);
                }
                // If this is a dashboard child, ensure only one stays
                const isDashboardChild = parent.id === 'dashboard' && /dashboard:/i.test(itemToMove.id);
                if(isDashboardChild){
                  assignedParent.children = [itemToMove];
                } else {
                  assignedParent.children.push(itemToMove);
                }
                break;
              }
            }
          }
        }
      });
      
      selectedAvailable.clear();
      
      // Rebuild available list from full tree to reflect changes
      available = buildAvailableList(fullNavTree, assigned);
      render();
    });

    // 🔹 Enhanced Remove logic - properly sync between panels
    removeBtn.addEventListener('click', () => {
      selectedAssigned.forEach(id => {
        // Find the item in assigned (could be child or standalone)
        let itemToMove = null;
        let wasChild = false;
        
        // First, check if it's a standalone item
        const standaloneIndex = assigned.findIndex(item => item.id === id && (!item.children || item.children.length === 0));
        if (standaloneIndex > -1) {
          itemToMove = assigned.splice(standaloneIndex, 1)[0];
        } else {
          // Look for it as a child item
          for (let i = 0; i < assigned.length; i++) {
            const parent = assigned[i];
            if (parent.children) {
              const childIndex = parent.children.findIndex(c => c.id === id);
              if (childIndex > -1) {
                itemToMove = parent.children.splice(childIndex, 1)[0];
                wasChild = true;
                
                // Remove parent from assigned if no children left
                if (parent.children.length === 0) {
                  assigned.splice(i, 1);
                }
                break;
              }
            }
          }
        }
      });
      
      selectedAssigned.clear();
      
      // Rebuild available list from full tree to reflect changes
      available = buildAvailableList(fullNavTree, assigned);
      // No special enforcement needed on remove.
      render();
    });

    selectAllBtn.addEventListener('click', () => { 
      // Clear and repopulate respecting single-dashboard rule
      selectedAvailable.clear();
      let dashboardChosen = false;
      flatten(available).forEach(p => {
        const isDashboard = /dashboard/i.test(p.label||'') || /dashboard/i.test(p.id||'');
        if(isDashboard){
          if(!dashboardChosen){
            selectedAvailable.add(p.id);
            dashboardChosen = true;
          }
        } else {
          selectedAvailable.add(p.id);
        }
      });
      if(dashboardChosen){
        showToast('Only one dashboard selected (rule enforced).');
      }
      render(); 
    });
    clearBtn.addEventListener('click', () => { 
      selectedAvailable.clear(); 
      selectedAssigned.clear(); 
      render(); 
    });

    globalSearch.addEventListener('input',()=> setTimeout(render,120));
    $('#clearSearchBtn')?.addEventListener('click',()=>{ globalSearch.value=''; render(); });

  userSelect.addEventListener('change',()=>{ fetchAssignedForCurrentSelection(); });
  // removed: selectAllUsersBtn handler
  if(orgTypeSelect) orgTypeSelect.addEventListener('change', async ()=>{
    if(!orgTypeSelect.value){ if(orgRoleSelect) orgRoleSelect.value=''; if(orgSelect) orgSelect.value=''; }
    if(orgSelect) await populateOrganizations({triggerChange:false});
    await populateRoles();
    fetchAssignedForCurrentSelection();
  });
  if(orgSelect) orgSelect.addEventListener('change',()=>{
    // Clearing user selection when org changes prevents stale user-based fetches
    if($('#userSelect')) Array.from($('#userSelect').options).forEach(o=>o.selected=false);
    if($('#userFilter')) $('#userFilter').value='';
    populateRoles().then(()=> fetchAssignedForCurrentSelection());
  });
  if(orgRoleSelect) orgRoleSelect.addEventListener('change',()=>{
    // Role-based view takes precedence when no specific user is selected
    if($('#userSelect')) Array.from($('#userSelect').options).forEach(o=>o.selected=false);
    if($('#userFilter')) $('#userFilter').value='';
    fetchAssignedForCurrentSelection();
  });

  // Removed duplicate bottom save button.

    // --- AJAX submit: apply propagation rules ---
    const formEl = document.getElementById('permissionsForm');
    if(formEl){
      formEl.addEventListener('submit', async (e)=>{
        e.preventDefault();
        // collect assignments (leaf ids in assigned panel)
        const assignedLeafIds = collectLeafIds(assigned);
        // Remember exactly what we saved to rebuild UI authoritatively
        lastSavedLeafIds = assignedLeafIds.slice();
        const selUsers = Array.from(userSelect.selectedOptions).map(o=>o.value).filter(Boolean);
        const roleId = orgRoleSelect ? (orgRoleSelect.value||'') : '';

        if(selUsers.length===0 && !roleId){
          showToast('Select a user or an organization role.','error');
          return;
        }

        // Payload per rules: if users picked => per-user override; else => role-based assignment
        const payload = selUsers.length>0 ? {
          assignments: assignedLeafIds,
          users: selUsers
        } : {
          assignments: assignedLeafIds,
          role: roleId
        };

        try{
          $('#saveText').textContent = 'Saving…';
          const sp = $('#saveSpinner'); if(sp) sp.style.display = 'inline-block';
          showOverlay('savingOverlay', true);
          const res = await fetch('{% url "api_save_sidebar_permissions" %}', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': (document.querySelector('[name=csrfmiddlewaretoken]')||{}).value || ''
            },
            body: JSON.stringify(payload)
          });
          const out = await res.json().catch(()=>({success:false}));
          if(!res.ok || !out.success) throw new Error(out.error||('HTTP '+res.status));
          // After successful save: refetch assignments for current selection
          try{
            await postSaveRefetchAndRender();
            showToast('Permissions saved.');
            // Ensure global sidebar reflects changes immediately for current user
            document.dispatchEvent(new CustomEvent('sidebar:permissions-updated'));
            // If the edited principal is the active user, perform a safe sidebar refresh w/ 403 handling
            try {
              const selUsersNow = Array.from(userSelect.selectedOptions).map(o=>o.value);
              if(selUsersNow.length===1 && window.USER_ID && String(selUsersNow[0])===String(window.USER_ID)){
                await refreshSidebarSnapshot();
              }
            } catch(_e){}
          }catch(_e){
            // As a fallback, refresh sidebar and reload
            try{ await refreshSidebarSnapshot(); }catch(_ee){}
          }
        }catch(err){
          console.error(err);
          showToast('Failed to save permissions.','error');
        }finally{
          $('#saveText').textContent = 'Save Changes';
          const sp = $('#saveSpinner'); if(sp) sp.style.display = 'none';
          showOverlay('savingOverlay', false);
        }
      });
    }

    // Safe sidebar refresh: handles loss of permission (403) then redirects gracefully
    async function refreshSidebarSnapshot(){
      try {
        const r = await fetch('{% url "api_my_sidebar" %}', {headers:{'X-Requested-With':'fetch'}});
        if(r.status === 403){
          window.location.href = '/';
          return;
        }
        if(r.ok){
          const data = await r.json().catch(()=>({allowed_nav_items:[]}));
          const allowed = data.allowed_nav_items || [];
          const stillAllowed = allowed.includes('sidebar_permissions') || allowed.includes('settings:sidebar_permissions');
          if(!stillAllowed){
            window.location.href = '/';
          } else {
            window.location.reload();
          }
        }
      } catch(_e) { /* ignore */ }
    }

    // Refetch assignments for current selection (user or role) and rebuild lists
    async function postSaveRefetchAndRender(){
      // Try to refetch from backend, but intersect with the just-saved leaf IDs
      // to avoid "effective" extras (role/dashboard merges) showing up as ghosts.
      let serverIds = null;
      try{
        const selUsers = Array.from(userSelect.selectedOptions).map(o=>o.value).filter(Boolean);
        const roleId = orgRoleSelect ? (orgRoleSelect.value||'') : '';
        let url = null;
        if(selUsers.length===1){
          url = `${'{% url "api_get_sidebar_permissions" %}'}?user=${encodeURIComponent(selUsers[0])}&effective=0`;
        }else if(!selUsers.length && roleId){
          url = `${'{% url "api_get_sidebar_permissions" %}'}?role=${encodeURIComponent(roleId)}&effective=0`;
        }
        if(url){
          const r = await fetch(url, {headers:{'X-Requested-With':'fetch'}});
          if(r.ok){
            const data = await r.json();
            if(Array.isArray(data.assignments)) serverIds = data.assignments;
          }
        }
      }catch(_e){ /* ignore and fall back to saved ids */ }

      let baseIds = Array.isArray(lastSavedLeafIds) ? lastSavedLeafIds.slice() : collectLeafIds(assigned);
      if(Array.isArray(serverIds)){
        const savedSet = new Set(baseIds);
        baseIds = serverIds.filter(id => savedSet.has(id));
      }
      const freshSet = new Set(baseIds);

      function pickAssignedFromTree(items){
        const out = [];
        for(const it of items){
          const ch = it.children && it.children.length ? pickAssignedFromTree(it.children) : [];
          if(ch.length){ out.push({id: it.id, label: it.label, children: ch}); }
          else if(freshSet.has(it.id)) { out.push({id: it.id, label: it.label}); }
        }
        return out;
      }
      assigned = pickAssignedFromTree(fullNavTree);
      available = buildAvailableList(fullNavTree, assigned);
      // Reset baseline so change indicator clears
      assignedData = JSON.parse(JSON.stringify(assigned));
      selectedAvailable.clear();
      selectedAssigned.clear();
      render();
    }


    function moveItems(sel, dir) {
      const ids = Array.from(sel);
      
      // Handle standalone items
      const standaloneIds = ids.filter(id => assigned.some(item => item.id === id && (!item.children || item.children.length === 0)));
      
      if (standaloneIds.length > 0) {
        const indices = standaloneIds.map(id => assigned.findIndex(p => p.id === id)).sort((a, b) => dir > 0 ? b - a : a - b);
        indices.forEach(i => {
          const j = i + dir;
          if (j >= 0 && j < assigned.length) {
            [assigned[i], assigned[j]] = [assigned[j], assigned[i]];
          }
        });
      }
      
      // Handle child items within their parent groups
      ids.forEach(id => {
        for (let parent of assigned) {
          if (parent.children) {
            const childIdx = parent.children.findIndex(c => c.id === id);
            if (childIdx > -1) {
              const newIdx = childIdx + dir;
              if (newIdx >= 0 && newIdx < parent.children.length) {
                [parent.children[childIdx], parent.children[newIdx]] = [parent.children[newIdx], parent.children[childIdx]];
              }
              break;
            }
          }
        }
      });
      
      render();
    }

    moveUpBtn.addEventListener('click', () => moveItems(selectedAssigned, -1));
    moveDownBtn.addEventListener('click', () => moveItems(selectedAssigned, 1));

    function flatten(list){
      let result=[];
      for(const item of list){
        if(item.children) result=result.concat(flatten(item.children));
        else result.push(item);
      }
      return result;
    }

    // Initial prepopulation using URL params
    (async function initFilters(){
      const params=new URLSearchParams(window.location.search);
      // Ensure organizations list matches selected org type
      await populateOrganizations({triggerChange:false});
      // Populate roles based on selected org or org type without reloading
      await populateRoles();
      // If URL has role, keep it selected after roles load
      const roleId = params.get('role');
      if(roleId){
        // Wait a tick to ensure options present
        setTimeout(()=>{ const opt=[...orgRoleSelect.options].find(o=>o.value===roleId); if(opt){ orgRoleSelect.value=roleId; } }, 100);
      }
    })();

    render();
    // Hide initial loading overlay now that first render is done
    showOverlay('loadingOverlay', false);
  });
</script>
{% endblock %}
