{% load static group_filters admin_tags %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{% block title %}CHRIST University - Central Command Center{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/x-icon" href="{% static 'core/img/favicon.ico' %}">
  
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  
  <!-- Styles -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" href="{% static 'core/css/base.css' %}">
  <link rel="stylesheet" href="{% static 'core/css/command-center.css' %}">
  {% block extra_css %}{% endblock %}
  
  {% block head_extra %}{% endblock %}
  <!-- CSRF token for JS (fallback to cookie also implemented in scripts) -->
  <meta name="csrf-token" content="{{ csrf_token }}">
  <!-- Auth status for JS (avoids inline template in script) -->
  <meta name="authenticated" content="{{ request.user.is_authenticated|yesno:'true,false' }}">
</head>
<body class="command-center-layout">

  {% if messages %}
  <div class="toast-container" aria-live="polite" aria-atomic="true">
    {% for message in messages %}
    <div class="toast-message {{ message.tags }}" role="alert">{{ message }}</div>
    {% endfor %}
  </div>
  {% endif %}

  {% impersonation_banner %}

  <!-- ZONE 1: TOP UTILITY BAR -->
  <div class="top-utility-bar">
    <div class="utility-bar-flex" style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
      <div class="utility-left" style="display: flex; align-items: center; gap: 1rem;">
        <button id="sidebarToggle" aria-label="Toggle sidebar" style="background:transparent;border:none;color:#fff;font-size:20px;display:flex;align-items:center;justify-content:center;width:36px;height:36px;border-radius:8px;">
          <span style="display:inline-block;width:18px;height:2px;background:#fff;position:relative;">
            <span style="content:'';position:absolute;left:0;top:-6px;width:18px;height:2px;background:#fff"></span>
            <span style="content:'';position:absolute;left:0;top:6px;width:18px;height:2px;background:#fff"></span>
          </span>
        </button>
        <div class="app-logo" style="display: flex; align-items: center; gap: 0.75rem;">
          <img src="{% static 'core/img/campus-logo.png' %}" alt="CHRIST University" class="logo-img">
          <span class="app-name">Event Management Suite</span>
        </div>
      </div>
      <div class="utility-center" style="flex: 1; display: flex; justify-content: center;">
        <div class="universal-search" style="max-width: 500px; width: 100%;">
          <i class="fas fa-search search-icon"></i>
          <input type="text" id="globalSearch" placeholder="Search students, reports, proposals..." class="search-input" autocomplete="off">
          <div class="search-shortcut">Ctrl+K</div>
          <div class="search-results" id="searchResults"></div>
        </div>
      </div>
      <div class="utility-right" style="display: flex; align-items: center; gap: 1.5rem;">
        <div class="notification-section">
          <button class="utility-btn notification-btn" id="notificationBtn" aria-label="Notifications">
            <i class="fa-solid fa-bell"></i>
            {% if notifications and notifications|length > 0 %}
            <span class="notification-badge" id="notificationBadge">{{ notifications|length }}</span>
            {% endif %}
          </button>
          <div class="notification-dropdown" id="notificationDropdown">
            <div class="notification-header">
              <h3>Notifications</h3>
              {% if notifications and notifications|length > 0 %}
              <button class="mark-all-read" id="markAllRead">Mark all read</button>
              {% endif %}
            </div>
            <div class="notification-list" id="notificationList">
              {% if notifications and notifications|length > 0 %}
                {% for notification in notifications %}
                <div class="notification-item {% if not notification.is_read %}unread{% endif %}">
                  <div class="notification-icon">
                    <i class="fa-solid fa-{{ notification.icon|default:'bell' }}"></i>
                  </div>
                  <div class="notification-content">
                    <div class="notification-title">{{ notification.title }}</div>
                    <div class="notification-text">{{ notification.message }}</div>
                    <div class="notification-time">{{ notification.created_at|timesince }} ago</div>
                  </div>
                </div>
                {% endfor %}
              {% else %}
              <div class="notification-item">
                <div class="notification-content" style="text-align: center; color: #6b7280; padding: 2rem;">
                  <div class="notification-title">No notifications</div>
                  <div class="notification-text">You're all caught up!</div>
                </div>
              </div>
              {% endif %}
            </div>
            {% if notifications and notifications|length > 0 %}
            <div class="notification-footer">
              <a href="/core-admin/notifications/" class="view-all-link">View all notifications</a>
            </div>
            {% endif %}
          </div>
        </div>
        <div class="profile-section">
          <button class="profile-btn" aria-label="Profile">
            <div class="profile-avatar">
              {{ request.user.get_full_name|default:request.user.username|slice:":1"|upper }}
            </div>
            <span class="profile-name">{{ request.user.get_full_name|default:request.user.username }}</span>
            <i class="fas fa-chevron-down"></i>
          </button>
          <div class="profile-dropdown">
            <div class="dropdown-header">
              <div class="user-info">
                <strong>{{ request.user.get_full_name|default:request.user.username }}</strong>
                <small>{{ request.session.role|default:"User" }}</small>
              </div>
            </div>
            <div class="dropdown-divider"></div>
            <a href="{% url 'my_profile' %}" class="dropdown-item">
              <i class="fas fa-user"></i> My Profile
            </a>
            <a href="{% url 'settings_pso_po_management' %}" class="dropdown-item" id="popso-settings-link" style="display: none;">
              <i class="fas fa-cogs"></i> PO/PSO Management
            </a>
            <a href="{% url 'logout' %}" class="dropdown-item">
              <i class="fas fa-sign-out-alt"></i> Logout
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ZONE 2: LEFT CONTROL PANEL -->
  <div class="left-control-panel">
    <nav class="control-navigation">
      
      {# Dynamic sidebar rendering from permissions tree #}
      {% if allowed_nav_tree %}
        {% for mod_slug, mod in sidebar_modules.items %}
          {% if allowed_nav_tree|get_item:mod_slug is not None %}
            {% with has_subs=mod.submodules|length %}
              {% if has_subs %}
              <div class="nav-section">
                <div class="nav-section-header">
                  <i class="{{ mod.icon }} nav-icon"></i>
                  <span class="nav-text">{{ mod.label }}</span>
                  <i class="fas fa-chevron-right expand-icon"></i>
                </div>
                <div class="nav-submenu">
                  {% with sel=allowed_nav_tree|get_item:mod_slug %}
                    {% if sel|length == 0 %}
                      {# full module assigned: show all submodules #}
                      {% for sm in mod.submodules %}
                        {% if sm.url %}
                          <a href="{{ sm.url }}" class="nav-sublink"><i class="fas fa-angle-right"></i> {{ sm.label }}</a>
                        {% else %}
                          <span class="nav-sublink">{{ sm.label }}</span>
                        {% endif %}
                      {% endfor %}
                    {% else %}
                      {# partial: only selected submodules #}
                      {% for sm in mod.submodules %}
                        {% if sm.slug in sel %}
                          {% if sm.url %}
                            <a href="{{ sm.url }}" class="nav-sublink"><i class="fas fa-angle-right"></i> {{ sm.label }}</a>
                          {% else %}
                            <span class="nav-sublink">{{ sm.label }}</span>
                          {% endif %}
                        {% endif %}
                      {% endfor %}
                    {% endif %}
                  {% endwith %}
                </div>
              </div>
              {% else %}
                <div class="nav-item">
                  <a href="{{ mod.url|default:'#' }}" class="nav-link">
                    <i class="{{ mod.icon }} nav-icon"></i>
                    <span class="nav-text">{{ mod.label }}</span>
                  </a>
                </div>
              {% endif %}
            {% endwith %}
          {% endif %}
        {% endfor %}
      {% else %}
        {# No restrictions: show everything from registry #}
        {% for mod_slug, mod in sidebar_modules.items %}
          {% if mod.submodules %}
          <div class="nav-section">
            <div class="nav-section-header">
              <i class="{{ mod.icon }} nav-icon"></i>
              <span class="nav-text">{{ mod.label }}</span>
              <i class="fas fa-chevron-right expand-icon"></i>
            </div>
            <div class="nav-submenu">
              {% for sm in mod.submodules %}
                {% if sm.url %}
                  <a href="{{ sm.url }}" class="nav-sublink"><i class="fas fa-angle-right"></i> {{ sm.label }}</a>
                {% else %}
                  <span class="nav-sublink">{{ sm.label }}</span>
                {% endif %}
              {% endfor %}
            </div>
          </div>
          {% else %}
          <div class="nav-item">
            <a href="{{ mod.url|default:'#' }}" class="nav-link">
              <i class="{{ mod.icon }} nav-icon"></i>
              <span class="nav-text">{{ mod.label }}</span>
            </a>
          </div>
          {% endif %}
        {% endfor %}
      {% endif %}

    </nav>
  </div>

  <!-- ZONE 3: MAIN VIEWSCREEN -->
  <div class="main-viewscreen main-content">
    <div class="viewscreen-content">
      {% block content %}
      <div class="welcome-screen">
        <h1>Welcome to IQAC Command Center</h1>
        <p>Select an option from the left panel to begin.</p>
      </div>
      {% endblock %}
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

  <!-- JavaScript for interactions -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const toasts = document.querySelectorAll('.toast-message');
      toasts.forEach(toast => {
        setTimeout(() => toast.classList.add('show'), 100);
        setTimeout(() => toast.classList.add('hide'), 5000);
        setTimeout(() => toast.remove(), 5500);
      });

      // Profile dropdown toggle
      const profileBtn = document.querySelector('.profile-btn');
      if (profileBtn) {
        profileBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          document.querySelector('.profile-dropdown').classList.toggle('active');
        });
      }

      // Notification dropdown toggle
      const notificationBtn = document.getElementById('notificationBtn');
      const notificationDropdown = document.getElementById('notificationDropdown');
      const markAllReadBtn = document.getElementById('markAllRead');

      if (notificationBtn && notificationDropdown) {
        notificationBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          notificationDropdown.classList.toggle('active');
          
          // Close profile dropdown if open
          const profileDropdown = document.querySelector('.profile-dropdown');
          if (profileDropdown) {
            profileDropdown.classList.remove('active');
          }
        });

        // Mark all as read functionality
        if (markAllReadBtn) {
          markAllReadBtn.addEventListener('click', function() {
            const unreadItems = document.querySelectorAll('.notification-item.unread');
            unreadItems.forEach(item => {
              item.classList.remove('unread');
            });
            
            // Update badge
            const badge = document.getElementById('notificationBadge');
            if (badge) {
              badge.style.display = 'none';
            }
          });
        }
      }

      // Navigation section expand/collapse
  const navHeaders = document.querySelectorAll('.nav-section-header');
      
      navHeaders.forEach(header => {
  header.addEventListener('click', function(e) {
          const section = this.parentElement;
          const submenu = section.querySelector('.nav-submenu');
          const icon = this.querySelector('.expand-icon');

          // Toggle the section
          if (section.classList.contains('expanded')) {
            // Collapse
            section.classList.remove('expanded');
            if (submenu) submenu.classList.remove('open');
            if (icon) icon.classList.remove('rotated');
          } else {
            // Expand  
            section.classList.add('expanded');
            if (submenu) submenu.classList.add('open');
            if (icon) icon.classList.add('rotated');
          }
        });
      });

      // Sidebar toggle (hamburger)
      const sidebarToggle = document.getElementById('sidebarToggle');
      sidebarToggle?.addEventListener('click', function(){
        document.body.classList.toggle('sidebar-collapsed');
      });

      // Universal Search Functionality
      const searchInput = document.getElementById('globalSearch');
      const searchResults = document.getElementById('searchResults');
      let searchTimeout;

      if (searchInput) {
        searchInput.addEventListener('input', function() {
          const query = this.value.trim();
          
          // Clear previous timeout
          clearTimeout(searchTimeout);
          
          if (query.length < 2) {
            searchResults.classList.remove('show');
            return;
          }

          // Show loading state
          searchResults.innerHTML = '<div class="search-loading">Searching...</div>';
          searchResults.classList.add('show');

          // Debounce search requests
          searchTimeout = setTimeout(() => {
            performSearch(query);
          }, 300);
        });

        // Hide search results when clicking outside
        document.addEventListener('click', function(e) {
          if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
            searchResults.classList.remove('show');
          }
        });

        // Show search results when focusing back on input
        searchInput.addEventListener('focus', function() {
          if (this.value.trim().length >= 2 && searchResults.innerHTML.trim()) {
            searchResults.classList.add('show');
          }
        });
      }

      function performSearch(query) {
        // Get CSRF token for Django
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                         document.querySelector('meta[name=csrf-token]')?.getAttribute('content') ||
                         getCookie('csrftoken');

        // Make AJAX request to Django API
        fetch(`/core-admin/api/search/?q=${encodeURIComponent(query)}`, {
          method: 'GET',
          headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json',
          },
          credentials: 'same-origin'
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              displaySearchResults(
                data.results.students || [], 
                data.results.proposals || [], 
                data.results.reports || [],
                data.results.users || [],
                query
              );
            } else {
              searchResults.innerHTML = `<div class="search-no-results">Search error: ${data.error || 'Unknown error'}</div>`;
              searchResults.classList.add('show');
            }
          })
          .catch(error => {
            console.error('Search error:', error);
            searchResults.innerHTML = `<div class="search-no-results">Search temporarily unavailable</div>`;
            searchResults.classList.add('show');
          });
      }

      // Helper function to get CSRF token from cookies
      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
            }
          }
        }
        return cookieValue;
      }

      function displaySearchResults(students, proposals, reports, users, query) {
        let html = '';

        if (students.length === 0 && proposals.length === 0 && reports.length === 0 && users.length === 0) {
          html = `<div class="search-no-results">No results found for "${query}"</div>`;
        } else {
          // Students section
          if (students.length > 0) {
            html += '<div class="search-category">Students</div>';
            students.forEach(student => {
              html += `
                <a href="${student.url}" class="search-item">
                  <div class="search-item-icon">
                    <i class="fas fa-graduation-cap"></i>
                  </div>
                  <div class="search-item-content">
                    <div class="search-item-title">${student.name}</div>
                    <div class="search-item-subtitle">Roll: ${student.roll_no} • ${student.course}</div>
                  </div>
                </a>
              `;
            });
          }

          // Proposals section
          if (proposals.length > 0) {
            html += '<div class="search-category">Event Proposals</div>';
            proposals.forEach(proposal => {
              html += `
                <a href="${proposal.url}" class="search-item">
                  <div class="search-item-icon">
                    <i class="fas fa-clipboard-list"></i>
                  </div>
                  <div class="search-item-content">
                    <div class="search-item-title">${proposal.title}</div>
                    <div class="search-item-subtitle">By ${proposal.faculty} • ${proposal.status} • ${proposal.date}</div>
                  </div>
                </a>
              `;
            });
          }

          // Reports section
          if (reports.length > 0) {
            html += '<div class="search-category">Reports</div>';
            reports.forEach(report => {
              html += `
                <a href="${report.url}" class="search-item">
                  <div class="search-item-icon">
                    <i class="fas fa-file-alt"></i>
                  </div>
                  <div class="search-item-content">
                    <div class="search-item-title">${report.title}</div>
                    <div class="search-item-subtitle">${report.date} • ${report.type}</div>
                  </div>
                </a>
              `;
            });
          }

          // Users section (for admins)
          if (users.length > 0) {
            html += '<div class="search-category">Users</div>';
            users.forEach(user => {
              html += `
                <a href="${user.url}" class="search-item">
                  <div class="search-item-icon">
                    <i class="fas fa-user"></i>
                  </div>
                  <div class="search-item-content">
                    <div class="search-item-title">${user.name}</div>
                    <div class="search-item-subtitle">${user.email} • ${user.role} • Last login: ${user.last_login}</div>
                  </div>
                </a>
              `;
            });
          }
        }

        searchResults.innerHTML = html;
        searchResults.classList.add('show');
      }

      // Search shortcut (Ctrl+K)
      document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.key === 'k') {
          e.preventDefault();
          const searchInput = document.querySelector('#globalSearch');
          if (searchInput) {
            searchInput.focus();
            searchInput.select();
          }
        }

        // Escape key to close search results
        if (e.key === 'Escape') {
          const searchResults = document.getElementById('searchResults');
          if (searchResults) {
            searchResults.classList.remove('show');
          }
        }
      });

      // Close dropdowns when clicking outside
      document.addEventListener('click', function(e) {
        // Close profile dropdown
        const profileDropdown = document.querySelector('.profile-dropdown');
        if (profileDropdown && !e.target.closest('.profile-section')) {
          profileDropdown.classList.remove('active');
        }

        // Close notification dropdown
        const notificationDropdown = document.getElementById('notificationDropdown');
        if (notificationDropdown && !e.target.closest('.notification-section')) {
          notificationDropdown.classList.remove('active');
        }
    });

    // Check if user is a PO/PSO manager and show Settings link
  const isAuthenticated = (document.querySelector('meta[name="authenticated"]')?.content === 'true');
    if (isAuthenticated) {
      checkPOPSOManagerStatus();
    }

    function checkPOPSOManagerStatus() {
      fetch('/core/api/popso-manager-status/')
        .then(response => response.json())
        .then(data => {
          if (data.is_manager) {
            const settingsLink = document.getElementById('popso-settings-link');
            if (settingsLink) {
              settingsLink.style.display = 'block';
            }
            const managerNav = document.getElementById('popso-manager-nav');
            if (managerNav) {
              managerNav.style.display = 'block';
            }
          }
        })
        .catch(error => {
          console.error('Error checking manager status:', error);
        });
    }
  });
  </script>
  {% block scripts %}{% endblock %}
  {% block scripts_extra %}{% endblock %}
  </body>
  </html>